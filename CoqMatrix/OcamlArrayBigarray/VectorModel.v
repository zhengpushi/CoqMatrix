(*
  Copyright 2023 ZhengPu Shi
  This file is part of VFCS. It is distributed under the MIT
  "expat license". You should have recieved a LICENSE file with it.

  purpose   : vector model
  author    : ZhengPu Shi
  date      : 2023.12

  remark    :
  1. Motivation:
     We want to get a verifiable and relative high performance representation of 
     vector and matrix in Coq, also including extracted code in OCaml.
     There are several ways:
     
     (1) DepPair, DepList, DepRecOfList
         特点：结构化的数据组织
         优点：
            * 可以在Coq中求值；
            * DepRecOfList抽取到的OCaml代码没有冗余，因对应到了list类型
         缺点：
            * 结构化的方式在处理转置，高斯消元，行列式等需要平等对待行列指标时很低效
            * DepPair, DepList抽取到的OCaml代码有冗余参数
     (2) NatFun, FinFun，FinFunByMC(表示MATHCOMP库中的实现)
         特点：函数式的数据组织
         优点：
            * NatFun和FinFun可以在Coq中求值。
            * 函数的编写和证明都简单很多，使得可以容易的验证复杂算法。
            * FinFun的类型安全性更高，但抽取出的OCaml去掉了依赖类型信息，也降低了安全性。
            * FinFunByMC已实现的理论最多，但需要较高的门槛。
         缺点：
            * 函数式方式在抽取出的OCaml实现在数据访问时效率较低
            * FinFunByMC无法在Coq中求值
     (3) axiomaized bassed on Array
         特点：
            * 公理化实现
            * 越界时无法完成证明，另外也会在OCaml中抛出异常。
         优点：
            * 提取出的OCaml代码直接对应array结构，运行效率高
            * 由于是抽象表示，利用模式匹配也可获得较高的证明自动化程度
         缺点：
            * 无法在Coq中求值
     (4) PArray
         特点：
            * 原生数组的直接支持
            * 提供“默认值”的支持，因此越界时不会引发异常
         优点：
            * 可在Coq中求值，而且效率高
            * 提取出的OCaml代码直接对应array结构，运行效率高
         缺点：
            * PArray没有长度概念，需要额外扩展
            * Uint63.int类型理论不熟悉，常需要与nat类型转换。
            * PArray应该是有4096的限制，我记得大概是这个数值
            * PArray没有将函数转化为数组的原生支持

  2. Several forms of a "vector"
     
     arr -- vec
     | \  / |
     |  \/  |
     |  /\  |
     | /  \ |
     F --- list

     arr : Array.array in OCaml
     vec : vector has given length, made be list
     F : natural-number-indexing-Function
     list : a list of data
     
     These forms have conversion functions between each other, such as:
     a2v <-> v2a,
     v2l <-> l2v,
     l2f <-> f2l,
     f2a <-> a2f, 
     ...
 *)


Require Export Extraction ExtrOcamlBasic ExtrOcamlNatInt MyExtrOCamlR.
Require Export Extraction NatExt ListExt.

(** Control the scope *)
Open Scope R_scope.
Open Scope nat_scope.
Open Scope A_scope.
Open Scope vec_scope.

(** Preserved notations *)
Reserved Infix "==" (at level 70).
Reserved Infix "===" (at level 70).
Reserved Notation "v .[ i ]"
  (at level 2, left associativity, format "v .[ i ]").
Reserved Notation "v .[ i <- a ]"
  (at level 2, left associativity, format "v .[ i <- a ]").
Reserved Notation "M .[ i , j ]"
  (at level 2, left associativity, format "M .[ i , j ]").
Reserved Notation "M .[ i , j <- a ]"
  (at level 2, left associativity, format "M .[ i , j <- a ]").


(** Tactics for automation *)

(* Try to rewrite *)
(* Ltac try_rw := *)
(*   match goal with *)
(*   | [H : ?a = ?b |- ?f ?a _ _ = ?f ?b _ _]     => rewrite H *)
(*   | [H : ?a = ?b |- ?f ?a _ = ?f ?b _]     => rewrite H *)
(*   | [H : ?a = ?b |- ?f ?a = ?f ?b ]     => rewrite H *)
(*   end. *)

(* Do logic works *)
Ltac logic :=
  repeat
    (match goal with
     | [|- _ -> _]              => intros
     | [H : _ /\ _ |- _]         => destruct H
     | [ |- _ /\ _ ]             => split
     | [H : _ |- _ <-> _ ]       => split; intros
     | [H : ?a = ?b |- _ ]      => try progress (rewrite H)
     | [H : ?a <> ?b |- False]       => destruct H
     end;
     auto).


(* Eliminitate nat comparison *)
Ltac nat_cmp :=
  repeat (
      intros;
      let E := fresh "E" in
      try match goal with
        | [ H : context [?i ??= ?j] |- _]  => destruct (i ??= j) as [E|E]
        | [ |- context [?i ??= ?j]]        => destruct (i ??= j) as [E|E]
        | [ H : context [?i ??< ?j] |- _]  => destruct (i ??< j) as [E|E]
        | [ |- context [?i ??< ?j]]        => destruct (i ??< j) as [E|E]
        | [ H : context [?i ??<= ?j] |- _] => destruct (i ??<= j) as [E|E]
        | [ |- context [?i ??<= ?j]]       => destruct (i ??<= j) as [E|E]
        (* `i = j |- _`, use it to rewrite *)
        | [H : ?i = ?j |- _] => match type of i with | nat => try rewrite H in * end
        end;
      auto; try reflexivity; try easy; try lia; try ring).



(** * Interface of vector model *)
Module Type VectorModel.
  
  (** ** vector operations *)

  (* vector type *)
  Parameter vec : forall {A : Type} (n : nat), Type.
  (* equality of two vectors *)
  Parameter veq : forall {A n} (v1 v2 : @vec A n), Prop.
  (* v.[i] *)
  Parameter vget : forall {A n} (v : @vec A n) (i : nat), A.
  (* v.[i<-a] *)
  Parameter vset : forall {A n} (v : @vec A n) (i : nat) (a : A), @vec A n.
  (* [a,a,...] *)
  Parameter vconst : forall {A} n (a : A), @vec A n.
  (* [f 0, f 1, ... ] *)
  Parameter f2v : forall {A} (n : nat) (f : nat -> A), @vec A n.

  (** ** notations for operations *)
  Infix "==" := veq : vec_scope.
  Notation "v .[ i ]" := (vget v i) : vec_scope.
  Notation "v .[ i <- a ]" := (vset v i a) : vec_scope.

  (** ** Specifications for vector operations *)

  (* veq is equivalent relation *)
  Axiom veq_equiv : forall {A n}, Equivalence (@veq A n).
  (* Two vector are equal if all corresponding elements are equal *)
  Axiom veq_if : forall {A n} (v1 v2 : @vec A n),
      (forall i, i < n -> v1.[i] = v2.[i]) -> v1 == v2.
  (* Two vector are equal imply all corresponding elements are equal *)
  Axiom veq_imply : forall {A n} (v1 v2 : @vec A n),
      v1 == v2 -> (forall i, i < n -> v1.[i] = v2.[i]).
  
  (* Get element of a vector after update with same index return the new value *)
  Axiom vset_eq : forall {A n} (v : @vec A n) (i : nat) (a : A),
      i < n -> (v.[i<-a]).[i] = a.
  (* Get element of a vector after update with different index return the old value *)
  Axiom vset_neq : forall {A n} (v : @vec A n) (i j : nat) (a : A),
      i < n -> j < n -> i <> j -> (v.[i<-a]).[j] = v.[j].
  (* Update element with its own value won't change the vector *)
  Axiom vset_same : forall {A n} (v : @vec A n) (i : nat) (a : A),
      i < n -> v.[i<-v.[i]] == v.
  (* Update element twice at same position will only keep last operation *)
  Axiom vset_shadow : forall {A n} (v : @vec A n) (i : nat) (a b : A),
      i < n -> v.[i<-a].[i<-b] == v.[i<-b].
  (* Update element twice at different position can exchange the operation *)
  Axiom vset_permute : forall {A n} (v : @vec A n) (i j : nat) (a b : A),
      i < n -> j < n -> i <> j -> v.[i<-a].[j<-b] == v.[j<-b].[i<-a].

  (* Get element from a constant vector return default value *)
  Axiom vget_vconst : forall {A n} (a : A) (i : nat),
      i < n -> (@vconst _ n a).[i] = a.
  (* Update element of a constant vector with its default value won't change it *)
  Axiom vset_vconst_same : forall {A n} (a : A) (i : nat),
      i < n -> (@vconst _ n a).[i<-a] == (@vconst _ n a).
  
  (* Get element from of a function-generated vector yields its corresponding value *)
  Axiom vget_f2v : forall {A n f} i, i < n -> (@f2v A n f).[i] = f i.
  (* Generate-vector-from-function is injective *)
  Axiom f2v_inj : forall {A} (n : nat) (f g : nat -> A),
      f2v n f == f2v n g -> (forall i, i < n -> f i = g i).

  (** ** Additional operations and properties for matrix type *)
  
  (* matrix type *)
  Notation mat A r c := (@vec (@vec A c) r).
  (* equality of two matrices *)
  Parameter meq : forall {A r c} (M1 M2 : @mat A r c), Prop.
  Infix "===" := meq : mat_scope.
  
  (* Two matrix are equal if all corresponding elements are equal *)
  Axiom meq_if : forall {A r c} (M1 M2 : @mat A r c),
      (forall i, i < r -> M1.[i] == M2.[i]) -> M1 === M2.
  (* Two matrix are equal imply all corresponding elements are equal *)
  Axiom meq_imply : forall {A r c} (M1 M2 : @mat A r c),
      M1 === M2 -> (forall i, i < r -> M1.[i] == M2.[i]).
  (* Get row of a matrix after update with same index return the new value *)
  Axiom msetr_eq : forall {A r c} (M : @mat A r c) (i : nat) (v : @vec A c),
      i < r -> (M.[i<-v]).[i] == v.
  (* Get row of a matrix after update with different index return the old value *)
  Axiom msetr_neq : forall {A r c} (M : @mat A r c) (i j : nat) (v : @vec A c),
      i < r -> j < r -> i <> j -> (M.[i<-v]).[j] == M.[j].
  
  
End VectorModel.


(** * Vector-Model by [OCaml Array]: High performance in OCaml *)
Module VectorModel_OCamlArray <: VectorModel.
  
  (** ** Basic operations *)

  (* vector type *)
  Parameter vec : forall {A : Type} (n : nat), Type.
  (* equality of two vectors *)
  Parameter veq : forall {A n} (v1 v2 : @vec A n), Prop.
  (* v.[i] *)
  Parameter vget : forall {A n} (v : @vec A n) (i : nat), A.
  (* v.[i<-a] *)
  Parameter vset : forall {A n} (v : @vec A n) (i : nat) (a : A), @vec A n.
  (* [a,a,...] *)
  Parameter vconst : forall {A} n (a : A), @vec A n.
  (* [f 0, f 1, ... ] *)
  Parameter f2v : forall {A} (n : nat) (f : nat -> A), @vec A n.

  (** ** notations for operations *)
  Infix "==" := veq : vec_scope.
  Notation "v .[ i ]" := (vget v i) : vec_scope.
  Notation "v .[ i <- a ]" := (vset v i a) : vec_scope.

  (** ** Specifications of the basic operations *)

  (* veq is equivalent relation *)
  Axiom veq_equiv : forall {A n}, Equivalence (@veq A n).
  (* Two vector are equal if all corresponding elements are equal *)
  Axiom veq_if : forall {A n} (v1 v2 : @vec A n),
      (forall i, i < n -> v1.[i] = v2.[i]) -> v1 == v2.
  (* Two vector are equal imply all corresponding elements are equal *)
  Axiom veq_imply : forall {A n} (v1 v2 : @vec A n),
      v1 == v2 -> (forall i, i < n -> v1.[i] = v2.[i]).
  
  (* Get element after a update operation with same index return the new value *)
  Axiom vset_eq : forall {A n} (v : @vec A n) (i : nat) (a : A),
      i < n -> (v.[i<-a]).[i] = a.
  (* Get element after a update operation with different index return the old value *)
  Axiom vset_neq : forall {A n} (v : @vec A n) (i j : nat) (a : A),
      i < n -> j < n -> i <> j -> (v.[i<-a]).[j] = v.[j].
  (* Update element with its own value won't change the vector *)
  Axiom vset_same : forall {A n} (v : @vec A n) (i : nat) (a : A),
      i < n -> v.[i<-v.[i]] == v.
  (* Update element twice at same position will only keep last operation *)
  Axiom vset_shadow : forall {A n} (v : @vec A n) (i : nat) (a b : A),
      i < n -> v.[i<-a].[i<-b] == v.[i<-b].
  (* Update element twice at different position can exchange the operation *)
  Axiom vset_permute : forall {A n} (v : @vec A n) (i j : nat) (a b : A),
      i < n -> j < n -> i <> j -> v.[i<-a].[j<-b] == v.[j<-b].[i<-a].

  (* Get element from a constant vector return default value *)
  Axiom vget_vconst : forall {A n} (a : A) (i : nat),
      i < n -> (@vconst _ n a).[i] = a.
  (* Update element of a constant vector with its default value won't change it *)
  Axiom vset_vconst_same : forall {A n} (a : A) (i : nat),
      i < n -> (@vconst _ n a).[i<-a] == (@vconst _ n a).
  
  (* Get element from of a function-generated vector yields its corresponding value *)
  Axiom vget_f2v : forall {A n f} i, i < n -> (@f2v A n f).[i] = f i.
  (* Generate-vector-from-function is injective *)
  Axiom f2v_inj : forall {A} (n : nat) (f g : nat -> A),
      f2v n f == f2v n g -> (forall i, i < n -> f i = g i).

  (** ** Additional operations and properties for matrix type *)

  (* matrix type *)
  Notation mat A r c := (@vec (@vec A c) r).
  (* equality of two matrices *)
  Parameter meq : forall {A r c} (M1 M2 : @mat A r c), Prop.
  Infix "===" := meq : mat_scope.
  
  (* Two matrix are equal if all corresponding elements are equal *)
  Axiom meq_if : forall {A r c} (M1 M2 : @mat A r c),
      (forall i, i < r -> M1.[i] == M2.[i]) -> M1 === M2.
  (* Two matrix are equal imply all corresponding elements are equal *)
  Axiom meq_imply : forall {A r c} (M1 M2 : @mat A r c),
      M1 === M2 -> (forall i, i < r -> M1.[i] == M2.[i]).
  (* Get row of a matrix after update with same index return the new value *)
  Axiom msetr_eq : forall {A r c} (M : @mat A r c) (i : nat) (v : @vec A c),
      i < r -> (M.[i<-v]).[i] == v.
  (* Get row of a matrix after update with different index return the old value *)
  Axiom msetr_neq : forall {A r c} (M : @mat A r c) (i j : nat) (v : @vec A c),
      i < r -> j < r -> i <> j -> (M.[i<-v]).[j] == M.[j].
  
  (** ** controlling extraction *)
  Extract Constant vec "'a" => "'a array".
  Extract Constant vget => "fun _ v -> Array.get v".
  Extract Constant vset "'a" =>
            "fun (_ : int) (v : 'a array) idx x -> Array.set v idx x; v".
  Extract Constant vconst => "Array.make".
  Extract Constant f2v => "Array.init".
  Recursive Extraction vget vset vconst f2v.
  Extraction "PVector.ml" vget vset vconst f2v.
  
End VectorModel_OCamlArray.


(** * Vector model by SafeNatFun: Support computation in Coq *)
Module VectorModel_SafeNatFun <: VectorModel.

  (** ** Basic operations *)
  (* vector type. Note, we cannot simply use `Inductive vec` due to module restriction *)
  Inductive t (A : Type) (n : nat) : Type := mk_vec (f : nat -> A).
  Definition vec (A : Type) (n : nat) : Type := t A n.
  
  (* Automatically convert vector to function *)
  Definition v2f {A n} (v : @vec A n) : nat -> A := let '(mk_vec _ _ f) := v in f.
  Coercion v2f : vec >-> Funclass.

  (* equality of two vectors *)
  Definition veq {A n} (v1 v2 : @vec A n) : Prop := forall i, i < n -> v1 i = v2 i.
  
  (* [f 0, f 1, ... ] *)
  Definition f2v {A n} (f : nat -> A) : @vec A n := mk_vec _ _ f.
  
  (* v.[i] *)
  Definition vget {A n} (v : @vec A n) (i : nat) : A := v i.

  (* v.[i<-a] *)
  Definition vset {A n} (v : @vec A n) (i : nat) (a : A) : @vec A n :=
    f2v (fun i0 => if i0 ??= i then a else v i0).
  
  (* [a,a,...] *)
  Definition vconst {A} n (a : A) : @vec A n := f2v (fun _ => a).

  (** ** notations for operations *)
  Infix "==" := veq : vec_scope.
  Notation "v .[ i ]" := (vget v i) : vec_scope.
  Notation "v .[ i <- a ]" := (vset v i a) : vec_scope.
  
  (** ** Specifications of the basic operations *)

  (* veq is equivalent relation *)
  Lemma veq_equiv : forall {A n}, Equivalence (@veq A n).
  Proof.
    intros; constructor; repeat intro; auto.
    rewrite (H i); auto. rewrite H,H0; auto.
  Qed.

  (* Two vector are equal if all corresponding elements are equal *)
  Lemma veq_if : forall {A n} (v1 v2 : @vec A n),
      (forall i, i < n -> v1.[i] = v2.[i]) -> v1 == v2.
  Proof. logic. Qed.
  
  (* Two vector are equal imply all corresponding elements are equal *)
  Lemma veq_imply : forall {A n} (v1 v2 : @vec A n),
      v1 == v2 -> (forall i, i < n -> v1.[i] = v2.[i]).
  Proof. logic. Qed.

  (* Get element after a update operation with same index return the new value *)
  Lemma vset_eq : forall {A n} (v : @vec A n) (i : nat) (a : A),
      i < n -> (v.[i<-a]).[i] = a.
  Proof. intros. simpl. nat_cmp. Qed.
  
  (* Get element after a update operation with different index return the old value *)
  Lemma vset_neq : forall {A n} (v : @vec A n) (i j : nat) (a : A),
      i < n -> j < n -> i <> j -> (v.[i<-a]).[j] = v.[j].
  Proof. intros. simpl. nat_cmp. Qed.
  
  (* Update element with its own value won't change the vector *)
  Lemma vset_same : forall {A n} (v : @vec A n) (i : nat) (a : A),
      i < n -> v.[i<-v.[i]] == v.
  Proof. intros. hnf; intros; simpl. nat_cmp. Qed.
  
  (* Update element twice at same position will only keep last operation *)
  Lemma vset_shadow : forall {A n} (v : @vec A n) (i : nat) (a b : A),
      i < n -> v.[i<-a].[i<-b] == v.[i<-b].
  Proof. intros. hnf; intros; simpl. nat_cmp. Qed.
  
  (* Update element twice at different position can exchange the operation *)
  Lemma vset_permute : forall {A n} (v : @vec A n) (i j : nat) (a b : A),
      i < n -> j < n -> i <> j -> v.[i<-a].[j<-b] == v.[j<-b].[i<-a].
  Proof. intros. hnf; intros; simpl. nat_cmp. Qed.

  (* Get element from a constant vector return default value *)
  Lemma vget_vconst : forall {A n} (a : A) (i : nat),
      i < n -> (@vconst _ n a).[i] = a.
  Proof. intros. simpl. nat_cmp. Qed.
  
  (* Update element of a constant vector with its default value won't change it *)
  Lemma vset_vconst_same : forall {A n} (a : A) (i : nat),
      i < n -> (@vconst _ n a).[i<-a] == (@vconst _ n a).
  Proof. intros. hnf; intros; simpl. nat_cmp. Qed.
  
  (* Get element from of a function-generated vector yields its corresponding value *)
  Lemma vget_f2v : forall {A n f} i, i < n -> (@f2v A n f).[i] = f i.
  Proof. intros. simpl. nat_cmp. Qed.
  
  (* Generate-vector-from-function is injective *)
  Lemma f2v_inj : forall {A} (n : nat) (f g : nat -> A),
      @f2v _ n f == f2v g -> (forall i, i < n -> f i = g i).
  Proof. intros. unfold f2v in H. specialize (H i H0). inv H. auto. Qed.

  (** ** Additional operations and properties for matrix type *)

  (* matrix type *)
  Notation mat A r c := (@vec (@vec A c) r).
  
  (* equality of two matrices *)
  Definition meq {A r c} (M1 M2 : @mat A r c) : Prop :=
    forall i, i < r -> (@veq A c (M1 i) (M2 i)).
  Infix "===" := meq : mat_scope.

  (* Two matrix are equal if all corresponding elements are equal *)
  Lemma meq_if : forall {A r c} (M1 M2 : @mat A r c),
      (forall i, i < r -> M1.[i] == M2.[i]) -> M1 === M2.
  Proof. logic. Qed.
  
  (* Two matrix are equal imply all corresponding elements are equal *)
  Lemma meq_imply : forall {A r c} (M1 M2 : @mat A r c),
      M1 === M2 -> (forall i, i < r -> M1.[i] == M2.[i]).
  Proof. logic. Qed.
  
  (* Get row of a matrix after update with same index return the new value *)
  Lemma msetr_eq : forall {A r c} (M : @mat A r c) (i : nat) (v : @vec A c),
      i < r -> (M.[i<-v]).[i] == v.
  Proof. logic. apply veq_if; intros. rewrite vset_eq; auto. Qed.
  
  (* Get row of a matrix after update with different index return the old value *)
  Lemma msetr_neq : forall {A r c} (M : @mat A r c) (i j : nat) (v : @vec A c),
      i < r -> j < r -> i <> j -> (M.[i<-v]).[j] == M.[j].
  Proof. logic. apply veq_if; intros. rewrite vset_neq; auto. Qed.

End VectorModel_SafeNatFun.


(** * Vector theory  *)
Module VectorTheory (E : VectorModel).
  Export E.
  
  (* ======================================================================= *)

  (** ** Cast between two [vec] type with actual equal range *)

  (** Cast from [vec n] type to [vec m] type if [n = m] *)
  Definition cast_vec {A n m} (v : @vec A n) (H: n = m) : @vec A m :=
    @eq_rect_r nat m (fun n0 : nat => vec n0 -> vec m) (fun v0 : vec m => v0) n H v.


  (* ======================================================================= *)
  (** ** Get element of a vector *)

  #[global]  Notation "a .1" := (a.[0]) : vec_scope.
  Notation "a .2" := (a.[1]) : vec_scope.
  Notation "a .3" := (a.[2]) : vec_scope.
  Notation "a .4" := (a.[3]) : vec_scope.
  Notation "a .x" := (a.[0]) : vec_scope.
  Notation "a .y" := (a.[1]) : vec_scope.
  Notation "a .z" := (a.[2]) : vec_scope.


  (* ======================================================================= *)
  (** ** Equality of vector *)

  Existing Instance veq_equiv.

  (** v1 == v2 <-> forall i, v1.[i] = v2.[i] *)
  Lemma veq_iff : forall {A n} (v1 v2 : @vec A n),
      v1 == v2 <-> (forall i, i < n -> v1.[i] = v2.[i]).
  Proof. intros. split; intros. apply veq_imply; auto. apply veq_if; auto. Qed.

  (* Proof equality of two vectors *)
  Ltac veq :=
    repeat
      (logic;
       try
         match goal with
         | [|- ?v1 == ?v2] => apply veq_if; intros
         | [H : ?i < S ?n |- ?a.[?i] = ?b.[?i]] => repeat (destruct i; auto; try lia)
         | [H : ?v1 == ?v2 |- ?v1.[?i] = ?v2.[?i]] => apply veq_imply
         end;
       auto; try lia).

  (** The equality of 0-D vector *)
  Lemma v0eq : forall {A} (v1 v2 : @vec A 0), v1 == v2.
  Proof. veq. Qed.

  (** The equality of 1-D vector *)
  Lemma v1eq_iff : forall {A} (v1 v2 : @vec A 1), v1 == v2 <-> v1.1 = v2.1.
  Proof. veq. Qed.

  Lemma v1neq_iff : forall {A} (v1 v2 : @vec A 1), ~(v1 == v2) <-> v1.1 <> v2.1.
  Proof. intros. rewrite v1eq_iff; tauto. Qed.

  (** The equality of 2-D vector *)
  Lemma v2eq_iff : forall {A} (v1 v2 : @vec A 2), v1 == v2 <-> v1.1 = v2.1 /\ v1.2 = v2.2.
  Proof. veq. Qed.

  Lemma v2neq_iff : forall {A} (v1 v2 : @vec A 2), ~(v1 == v2) <-> (v1.1 <> v2.1 \/ v1.2 <> v2.2).
  Proof. intros. rewrite v2eq_iff; tauto. Qed.

  (** The equality of 3-D vector *)
  Lemma v3eq_iff : forall {A} (v1 v2 : @vec A 3),
      v1 == v2 <-> v1.1 = v2.1 /\ v1.2 = v2.2 /\ v1.3 = v2.3.
  Proof. veq. Qed.

  Lemma v3neq_iff : forall {A} (v1 v2 : @vec A 3),
      ~(v1 == v2) <-> (v1.1 <> v2.1 \/ v1.2 <> v2.2 \/ v1.3 <> v2.3).
  Proof. intros. rewrite v3eq_iff; tauto. Qed.

  (** The equality of 4-D vector *)
  Lemma v4eq_iff : forall {A} (v1 v2 : @vec A 4),
      v1 == v2 <-> v1.1 = v2.1 /\ v1.2 = v2.2 /\ v1.3 = v2.3 /\ v1.4 = v2.4.
  Proof. veq. Qed.

  Lemma v4neq_iff : forall {A} (v1 v2 : @vec A 4),
      ~(v1 == v2) <-> (v1.1 <> v2.1 \/ v1.2 <> v2.2 \/ v1.3 <> v2.3 \/ v1.4 <> v2.4).
  Proof. intros. rewrite v4eq_iff; tauto. Qed.

  (** ~(v1 == v2) <-> ∃ i, u $ i <> v $ i *)
  Lemma vneq_iff_exist_nth_neq : forall {A n} (v1 v2 : @vec A n),
      ~(v1 == v2) <-> exists i, i < n /\ v1.[i] <> v2.[i].
  Proof.
    intros. logic.
    - rewrite veq_iff in H.
      apply not_all_ex_not in H. destruct H as [n0 H]. exists n0. tauto.
    - rewrite veq_iff. destruct H as [i H].
      intro. specialize (H0 i). tauto.
  Qed.


  (* ======================================================================= *)
  (** ** Vector with same elements *)
  Section vrepeat.
    Context {A} {Azero : A} {n : nat}.

    Definition vrepeat (a : A) : @vec A n := vconst n a.

    (** (repeat a).i = a *)
    Lemma nth_vrepeat : forall a i, i < n -> (vrepeat a).[i] = a.
    Proof. intros. unfold vrepeat. rewrite vget_vconst; auto. Qed.
  End vrepeat.


  (* Module VectorTheory_OCamlArray := VectorTheory VectorModel_OCamlArray. *)
  (* Module VectorTheory_SafeNatFun := VectorTheory VectorModel_SafeNatFun. *)

  (* Recursive Extraction VectorTheory_SafeNatFun. *)
  (* Extraction "VectorTheoryF.ml" VectorTheory_SafeNatFun. *)

  (* Recursive Extraction VectorTheory_OCamlArray. *)
  (* Extraction "VectorTheoryA.ml" VectorTheory_OCamlArray. *)

  (* Import VectorTheory_SafeNatFun. *)
  (* Compute (@vrepeat nat 3 0).1. *)


  (* ======================================================================= *)
  (** ** Zero vector *)
  Section vzero.
    Context {A} (Azero : A) {n : nat}.
    
    Definition vzero : @vec A n := vrepeat Azero.

    (** vzero.i = 0 *)
    Lemma nth_vzero : forall i, i < n -> vzero.[i] = Azero.
    Proof. intros. apply nth_vrepeat; auto. Qed.
    
  End vzero.


  (* Eliminitate index operation *)
  Ltac idx :=
    repeat (
        intros;
        let E := fresh "E" in
        try match goal with
          (* i = i |- _ *)
          | H : ?i = ?i |- _ => clear H
          (* vzero $ i = 0 *)
          | [|- context [(vzero _).[?i]]] => rewrite nth_vzero
          (* (f2v f) i = f i *)
          | [ |- context [(f2v _ ?f).[?i]]]     => rewrite vget_f2v
          (* (a.[i<-x].[i] = x *)
          | [|- context [(?a.[?i<-?x]).[?i]]]                 => rewrite vset_eq
          | [H : ?i = ?j |- context [(?a.[?i<-?x]).[?j]]]     => rewrite H, vset_eq
          | [H : ?j = ?i |- context [(?a.[?i<-?x]).[?j]]]     => rewrite H, vset_eq
          (* (a.[i<-x].[j] = a.[j] *)
          | [H : ?i <> ?j |- context [(?a.[?i<-?x]).[?j]]]     => rewrite vset_neq
          | [H : ?j <> ?i |- context [(?a.[?i<-?x]).[?j]]]     => rewrite vset_neq
          (* (a.[i<-x].[i<-y] = a.[i<-x] *)
          | [ |- context [?a.[?i<-_].[?i<-_]]]      => rewrite vset_shadow
          (* ((vconst a).[i<-a] = (vconst a) *)
          | [ |- context [(vconst _ ?a).[?i<-?a]]]  => rewrite vset_vconst_same
          (* destruct `??=, ??<, ??<=` *)
          | [ H : context [?i ??= ?j] |- _]  => destruct (i ??= j) as [E|E]
          | [ |- context [?i ??= ?j]]        => destruct (i ??= j) as [E|E]
          | [ H : context [?i ??< ?j] |- _]  => destruct (i ??< j) as [E|E]
          | [ |- context [?i ??< ?j]]        => destruct (i ??< j) as [E|E]
          | [ H : context [?i ??<= ?j] |- _] => destruct (i ??<= j) as [E|E]
          | [ |- context [?i ??<= ?j]]       => destruct (i ??<= j) as [E|E]
          (* `i = j |- _`, use it to rewrite *)
          | [H : ?i = ?j |- _] => match type of i with | nat => try rewrite H in * end
          end;
        auto; try reflexivity; try easy; try lia; try ring).

  Ltac idx_perm :=
    match goal with
    (* (a.[i<-x].[j<-y]).[i] = (a.[j<-y].[i<-x]).[i] *)
    (* | [|- context [(?a.[?i<-?x].[?j<-?y]).[?i]]] => rewrite vset_permute *)
    | [|- context [?a.[?i<-?x].[?j<-?y]]] => rewrite vset_permute
    end; idx.


  (* ======================================================================= *)
  (** ** Basic support for matrix *)

  Notation "M .[ i , j ]" := (M.[i].[j]) : mat_scope.
  
  (* Note, the set operation efficiency maybe is a bit low, since one row operation *)
  Notation "M .[ i , j <- a ]" := (M.[i<-M.[i].[j<-a]]) : mat_scope.
  
  (* Get element of a matrix after update with same index return the new value *)
  Lemma mset_eq : forall {A r c} (M : @mat A r c) (i j : nat) (a : A),
      i < r -> j < c -> M.[i,j<-a].[i,j] = a.
  Proof. intros. idx. Qed.

  (* (* Get element of a vector after update with same index return the new value *) *)
  (* Lemma mset_eq : forall {A n} (v : @vec A n) (i : nat) (a : A), *)
  (*     i < n -> (v.[i<-a]).[i] = a. *)
  (* (* Get element of a vector after update with different index return the old value *) *)
  (* Lemma mset_neq : forall {A n} (v : @vec A n) (i j : nat) (a : A), *)
  (*     i < n -> j < n -> i <> j -> (v.[i<-a]).[j] = v.[j]. *)
  (* (* Update element with its own value won't change the vector *) *)
  (* Lemma mset_same : forall {A n} (v : @vec A n) (i : nat) (a : A), *)
  (*     i < n -> v.[i<-v.[i]] == v. *)
  (* (* Update element twice at same position will only keep last operation *) *)
  (* Lemma mset_shadow : forall {A n} (v : @vec A n) (i : nat) (a b : A), *)
  (*     i < n -> v.[i<-a].[i<-b] == v.[i<-b]. *)
  (* (* Update element twice at different position can exchange the operation *) *)
  (* Lemma mset_permute : forall {A n} (v : @vec A n) (i j : nat) (a b : A), *)
  (*     i < n -> j < n -> i <> j -> v.[i<-a].[j<-b] == v.[j<-b].[i<-a]. *)
                                         

  (* ======================================================================= *)
  (** ** Convert between nat-index-function (f) and vector (v) *)
  Section f2v_v2f.
    Context {A} (Azero : A).

    Definition v2f {n} (v : @vec A n) : (nat -> A) := vget v.
    
    (** (f2v f).i = f i *)
    Lemma nth_f2v : forall {n} f i, i < n -> (@f2v A n f).[i] = f i.
    Proof. intros. simpl. idx. Qed.

    (** (v2f v) i = v.i *)
    Lemma nth_v2f : forall {n} (v : vec n) i, i < n -> (v2f v) i = v.[i].
    Proof. intros. unfold v2f. auto. Qed.

    (** f2v (v2f v) = v *)
    Lemma f2v_v2f : forall {n} (v : vec n), (f2v n (v2f v)) == v.
    Proof. intros. unfold v2f. veq. idx. Qed.

    (** v2f (f2v f) = f *)
    Lemma v2f_f2v : forall {n} (f : nat -> A) i, i < n -> v2f (f2v n f) i = f i.
    Proof. intros. unfold v2f. idx. Qed.

  End f2v_v2f.


  (* ======================================================================= *)
  (** ** Convert between list and vector *)
  Section l2v_v2l.
    Context {A} (Azero : A).

    Definition l2v {n : nat} (l : list A) : @vec A n := f2v n (l2f Azero n l).

    (** (l2v l).i = nth i l *)
    Lemma nth_l2v : forall {n} (l : list A) i, i < n -> (@l2v n l).[i] = nth i l Azero.
    Proof. intros. unfold l2v. rewrite nth_f2v; auto. Qed.

    (** l2v l1 = l2v l2 -> l1 = l2 *)
    Lemma l2v_inj : forall {n} (l1 l2 : list A),
        length l1 = n -> length l2 = n -> @l2v n l1 == @l2v n l2 -> l1 = l2.
    Proof.
      intros. unfold l2v in *.
      apply (l2f_inj Azero n); auto; intros.
      apply f2v_inj with (i:=i) in H1; auto.
    Qed.

    
    Definition v2l {n} (v : @vec A n) : list A := f2l n (v2f v).
    
    (** length (v2l a) = n *)
    Lemma v2l_length : forall {n} (v : vec n), length (v2l v) = n.
    Proof. intros. unfold v2l. apply f2l_length. Qed.

    (** nth i (v2l a) = a.i *)
    Lemma nth_v2l : forall {n} (v : vec n) (i : nat), i < n -> nth i (v2l v) Azero = v.[i].
    Proof. intros. unfold v2l. rewrite nth_f2l; auto. Qed.

    (** v2l v1 = v2l v2 -> v1 = v2 *)
    Lemma v2l_inj : forall {n} (v1 v2 : vec n), v2l v1 = v2l v2 -> v1 == v2.
    Proof. intros. unfold v2l in *. veq. apply f2l_inj with (i:=i) in H; auto. Qed.

    
    (** l2v (v2l v) = v *)
    Lemma l2v_v2l : forall {n} (v : vec n), (@l2v n (v2l v)) == v.
    Proof. intros. unfold l2v,v2l. veq. idx. apply l2f_f2l; auto. Qed.

    (** v2l (l2v l) = l *)
    Lemma v2l_l2v : forall {n} (l : list A), length l = n -> v2l (@l2v n l) = l.
    Proof.
      intros. unfold l2v,v2l.
      apply (list_eq_ext Azero n); auto; intros.
      - rewrite nth_f2l; auto. rewrite v2f_f2v; auto.
      - apply f2l_length.
    Qed.
    
    (** ∀ l, (∃ v, v2l v = l) *)
    Lemma v2l_surj : forall {n} (l : list A), length l = n -> (exists v : vec n, v2l v = l).
    Proof. intros. exists (l2v l). apply v2l_l2v; auto. Qed.
    
    (** ∀ v, (∃ l, l2v l = a) *)
    Lemma l2v_surj : forall {n} (v : vec n), (exists l, @l2v n l == v).
    Proof. intros. exists (v2l v). apply l2v_v2l; auto. Qed.

  End l2v_v2l.


  (* ======================================================================= *)
  (** ** vector with specific size *)
  Section vec_specific.
    Context {A} {Azero : A}.
    Variable a1 a2 a3 a4 : A.
    
    Definition mkvec0 : @vec A 0 := l2v Azero [].
    Definition mkvec1 : @vec A 1 := l2v Azero [a1].
    Definition mkvec2 : @vec A 2 := l2v Azero [a1;a2].
    Definition mkvec3 : @vec A 3 := l2v Azero [a1;a2;a3].
    Definition mkvec4 : @vec A 4 := l2v Azero [a1;a2;a3;a4].
  End vec_specific.

  (* Lemma meq_equiv : forall {A r c}, Equivalence (@veq (@vec A c) r). *)
  (* Admitted. *)
  (* Existing Instance meq_equiv. *)
  (* x, y : @vec (@vec A r) c *)
  (* H : @veq (@vec A r) c x y *)
  (* y0 : nat *)
  (* x1, y1 : @vec A r *)
  (* H1 : @veq A r x1 y1 *)
  (* ============================ *)
  (* @veq (@vec A r) c (@vset (@vec A r) c x y0 x1) (@vset (@vec A r) c y y0 y1) *)


  (* (M1 === M2) -> v1 == v2 -> i = j -> i < r -> j < r -> M1.[i<-v1] === M2.[i<-v2] *)
  Lemma msetr_meq : forall {A r c} (M1 M2 : @mat A r c) (v1 v2 : @vec A c) i j,
      M1 === M2 -> v1 == v2 -> i = j -> i < r -> j < r -> M1.[i<-v1] === M2.[j<-v2].
  Proof.
    intros. apply meq_if; intros. destruct (i ??= i0).
    - subst. apply meq_imply with (i:=i0) in H; auto. idx.
    - idx. apply meq_imply with (i:=i0); auto.
  Qed.
  
  (* Lemma msetr_meq_mor : forall {A r c}, *)
  (*     Proper (meq ==> eq ==> veq ==> meq) ((fun M => @vset (@vec A c) r M)). *)
  (* Proof. *)
  (* Lemma msetr_meq_mor : forall {A r c}, *)
  (*     Proper (meq ==> eq ==> veq ==> meq) (@vset (@vec A c) r). *)
  (* Proof. *)
  (*   repeat intro. *)
  (*   apply msetr_meq; auto. *)
  (* Existing Instance vset_mat_mor. *)

  (** 检查PArray对证明的支持 *)
  Section proof_test.
    Variable A : Type.
    Variable a b c : A.

    (* 一个给定维度的具体向量，可通过计算直接得证 *)
    (* [a;a] = ([a,a] <- 0,b <- 0,a) *)
    Goal (vconst 2 a) == vset (vset (vconst 2 a) 0 b) 0 a.
    Proof. idx. Qed.

    (* 对长度为2的向量进行越界读写，此时并不会进行类型检查。
       并且由于是在函子中使用了抽象的模型，此时不进行具体运算，也加快了速度。
       当使用OCaml中的 array 模型时，越界时会触发异常。
       此外，Coq中验证过的函数不会出现越界访问。 *)
    Compute vget (vconst 2 a) 5.
    Compute vset (vconst 2 a) 5 b.
    
    (* 以下命题无法得证。左侧表示，越界写入数据 *)
    Goal vset (vconst 2 a) 5 b == vconst 2 a.
    Proof. idx. apply veq_if; intros. Abort.

    (* 任意维度时，就不能通过计算来证明了，需要使用性质来验证 *)
    Goal forall n i, i < n -> vconst n a == (vconst n a).[i<-a].
    Proof. idx. Qed.

    Variable M : @mat nat 3 4.
    Goal M.[0,1<-3].[0,2<-2] === M.[0,2<-2].[0,1<-3].
    Proof.
      idx.
      apply meq_if; intros. idx.
      ??
      unfold meq.
      Check mset.
      match goal with
      | [ |- context [?M.[?i1,?j1<-?a1].[?i2,?j2<-?a2]]] =>
          replace i1 with j2
      end.
      
      unfold mset. idx.
      apply meq_if; intros.
      
      idx.
      apply vset_mat_mor; idx.
      idx_perm.
    Qed.
    ?    
      End proof_test.


    (* ======================================================================= *)
    (** ** 自然基的基向量 *)
    Section veye.
      Context {A} (Azero Aone : A).
      Notation "0" := Azero : A_scope.
      Notation "1" := Aone : A_scope.
      Notation vzero := (vzero 0).
      Context {one_neq_zero : 1 <> 0}.

      Definition veye {n} (i : nat) : @vec A n :=
        f2v (fun j => if i ??= j then 1 else 0).
      
      (** (veye i).i = 1 *)
      Lemma nth_veye_eq : forall {n} i, i < n -> (@veye n i).[i] = 1.
      Proof. intros. unfold veye. idx. Qed.

      (** (veye i).j = 0 *)
      Lemma nth_veye_neq : forall {n} i j, i <> j -> j < n -> (@veye n i).[j] = 0.
      Proof. intros. unfold veye. idx. Qed.

      (** veye <> 0 *)
      Lemma veye_neq0 : forall {n} i, i < n -> @veye n i <> vzero.
      Proof.
        intros. intro. rewrite veq_iff in H0. specialize (H0 i H).
        rewrite nth_veye_eq, nth_vzero in H0; auto.
      Qed.
      
    End veye.


    (* ======================================================================= *)
    (** ** natural basis, 自然基（最常见的一种标准正交基) *)
    Section veyes.
      Context {A} (Azero Aone : A).
      Notation "0" := Azero : A_scope.
      Notation "1" := Aone : A_scope.
      Notation vzero := (vzero 0).
      Context {one_neq_zero : 1 <> 0}.

      Definition veyes (n : nat) : @vec (@vec A n) n := f2v (fun i => veye 0 1 i).

      (** veyes.ii = 1 *)
      Lemma nth_veyes_eq : forall {n} i, i < n -> (veyes n).[i].[i] = 1.
      Proof. intros. unfold veyes. idx. apply nth_veye_eq; auto. Qed.

      (** veyes.ij = 0 *)
      Lemma nth_veyes_neq : forall {n} i j, i <> j -> i < n -> j < n -> (veyes n).[i].[j] = 0.
      Proof. intros. unfold veyes. idx. apply nth_veye_neq; auto. Qed.
      
    End veyes.



    (* ======================================================================= *)
    (** ** Mapping of a vector *)
    Section vmap.
      Context {V1 V2 : Type} (f : A -> B).
      
      Definition vmap {n} (v : @vec A n) : @vec B n := f2v (fun i => f (v.[i])).

      (** (vmap f a).i = f (a.i) *)
      Lemma nth_vmap : forall {n} (v : vec n) i, i < n -> (vmap v).[i] = f (v.[i]).
      Proof. intros. unfold vmap. idx. Qed.

    End vmap.


    (* ======================================================================= *)
    (** ** Mapping of two vectors *)
    Section vmap2.
      Context {V1 V2 C : Type} (f : A -> B -> C).
      
      Definition vmap2 {n} (v1 : @vec A n) (v2 : @vec B n) : @vec C n :=
        f2v (fun i => f v1.[i] v2.[i]).

      (** (vmap2 f v1 v2).i = f (v1.i) (v2.i) *)
      Lemma nth_vmap2 : forall {n} (v1 v2 : vec n) i,
          i < n -> (vmap2 v1 v2).[i] = f v1.[i] v2.[i].
      Proof. intros. unfold vmap2; auto. idx. Qed.

      (* vmap2 f v1 v2 = vmap id (fun i => f u.i v.i) *)
      Lemma vmap2_eq_vmap : forall {n} (v1 v2 : vec n),
          vmap2 v1 v2 = vmap (fun a => a) (f2v (fun i => f v1.[i] v2.[i])).
      Proof. intros. apply veq_iff; intros. rewrite nth_vmap2, nth_vmap; idx. Qed.
      
    End vmap2.


    (** vmap2 on same type *)
    Section vmap2_sametype.
      Context `{ASGroup}.

      (** vmap2 f v1 v2 = vmap2 f b a *)
      Lemma vmap2_comm : forall {n} (v1 v2 : vec n),
          vmap2 Aadd v1 v2 = vmap2 Aadd v2 v1.
      Proof.
        intros. apply veq_iff; intros. rewrite !nth_vmap2; idx. asemigroup.
      Qed.
      
      (** vmap2 f (vmap2 f v1 v2) v3 = vmap2 f v1 (vmap2 f v2 v3) *)
      Lemma vmap2_assoc : forall {n} (v1 v2 v3 : vec n),
          vmap2 Aadd (vmap2 Aadd v1 v2) v3 = vmap2 Aadd v1 (vmap2 Aadd v2 v3).
      Proof.
        intros. apply veq_iff; intros. rewrite !nth_vmap2; idx. asemigroup.
      Qed.
    End vmap2_sametype.


    (* ======================================================================= *)
    (** ** Set element of a vector *)
    Section vset.
      Context {A} {Azero : A}.

      (* Lemma vset_eq : forall {n} (v : @vec A n) (i : nat) (x : A), *)
      (*     i < n -> vset v i x = f2v (fun j => if j ??= i then x else v.[j]). *)
      (* Proof. intros. apply veq_iff; intros. unfold vset. idx. Qed. *)

      (* (** (vset a i x).i = x *) *)
      (* Lemma nth_vset_eq : forall {n} (v : @vec A n) (i : nat) (x : A), *)
      (*     i < n -> (vset v i x).[i] = x. *)
      (* Proof. intros. unfold vset. idx. Qed. *)
      
      (** (vset a i x).j = a.[j *)
      Lemma nth_vset_neq : forall {n} (v : @vec A n) (i j : nat) (x : A),
          i <> j -> i < n -> j < n -> (vset v i x).[j] = v.[j].
      Proof. intros. unfold vset. idx. Qed.
      
    End vset.


    (* ======================================================================= *)
    (** ** Swap two element of a vector *)
    Section vswap.
      Context {A : Type}.
      
      (* Swap the i-th and j-th element of vector `a` *)
      Definition vswap {n} (v : @vec A n) (i j : nat) : @vec A n :=
        a <- i, (a$j) <- j, (a$i).

      Lemma vswap_eq : forall {n} (v : @vec A n) (i j : nat),
          i < n -> j < n ->
          vswap a i j = 
            f2v (fun k => if k ??= i then a$j
                          else (if k ??= j then a$i else a$k)).
      Proof. intros. apply veq_iff; intros. unfold vswap. idx. idx_perm. Qed.

      Lemma nth_vswap_i : forall {n} (v : @vec A n) (i j : nat),
          i < n -> j < n -> (vswap a i j).[i = a.[j.
                                                  Proof. intros. unfold vswap. idx. idx_perm. Qed.

                                                  Lemma nth_vswap_j : forall {n} (v : @vec A n) (i j : nat),
                                                      j < n -> (vswap a i j).[j = a.[i.
                                                                                     Proof. intros. unfold vswap. idx. Qed.

                                                                                     Lemma nth_vswap_other : forall {n} (v : @vec A n) (i j k : nat),
                                                                                         i <> k -> j <> k -> i < n -> j < n -> k < n -> (vswap a i j).[k = a.[k.
                                                                                                                                                              Proof. intros. unfold vswap. idx. Qed.

                                                                                                                                                              Lemma vswap_vswap : forall {n} (v : @vec A n) (i j : nat),
                                                                                                                                                                  i < n -> j < n -> vswap (vswap a i j) j i = a.
                                                                                                                                                              Proof.
                                                                                                                                                                intros. apply veq_iff; intros. unfold vswap.
                                                                                                                                                                destruct (i ??= i0), (j ??= i0); idx.
                                                                                                                                                              Qed.

                                                                                                                                                              End vswap.


                                                                                                                                                              (* ======================================================================= *)
                                                                                                                                                              (** ** Insert element to a vector *)
                                                                                                                                                              Section vinsert.
                                                                                                                                                                Context {A} {Azero : A}.
                                                                                                                                                                (* Notation vzero := (vzero Azero). *)

                                                                                                                                                                Definition vinsert {n} (v : @vec A n) (i : nat) (x : A) : @vec A (S n) :=
                                                                                                                                                                  f2v (fun j => if j ??< i then a.[j else
                                                                                                                                                                                                     if j ??= i then x
                                                                                                                                                                                                     else (a.[(pred j))).

                                                                                                                                                                                                   (** j < i -> (vinsert a i x).j = a.i *)
                                                                                                                                                                                                   Lemma nth_vinsert_lt : forall {n} (v : @vec A n) (i : nat) (x : A) (j : nat),
                                                                                                                                                                                                       j < i -> i < n -> j < n -> (vinsert a i x).[j = a.[j.
                                                                                                                                                                                                                                                          Proof. intros. unfold vinsert. idx. Qed.

                                                                                                                                                                                                                                                          (** (vinsert a i x).i = x *)
                                                                                                                                                                                                                                                          Lemma nth_vinsert_eq : forall {n} (v : @vec A n) (i : nat) (x : A),
                                                                                                                                                                                                                                                              i <= n -> (vinsert a i x).[i = x.
                                                                                                                                                                                                                                                                                         Proof. intros. unfold vinsert. idx. Qed.
                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                         (** i < j -> (vinsert a i x).j = a.(S i) *)
                                                                                                                                                                                                                                                                                         Lemma nth_vinsert_gt : forall {n} (v : @vec A n) (i : nat) (x : A) (j : nat),
                                                                                                                                                                                                                                                                                             i < j -> j <= n -> (vinsert a i x).[j = a.[(pred j).
                                                                                                                                                                                                                                                                                                                                        Proof. intros. unfold vinsert. idx. Qed.

                                                                                                                                                                                                                                                                                                                                        (** (vzero <<- Azero) = vzero *)
                                                                                                                                                                                                                                                                                                                                        Lemma vinsert_vzero_0 : forall {n} i,
                                                                                                                                                                                                                                                                                                                                            i < n -> @vinsert n (vzero Azero) i Azero = (vzero Azero).
                                                                                                                                                                                                                                                                                                                                        Proof.
                                                                                                                                                                                                                                                                                                                                          intros. apply veq_iff; intros. rewrite nth_vzero; auto.
                                                                                                                                                                                                                                                                                                                                          destruct (i0 ??< i).
                                                                                                                                                                                                                                                                                                                                          - rewrite nth_vinsert_lt; idx.
                                                                                                                                                                                                                                                                                                                                          - destruct (i0 ??= i).
                                                                                                                                                                                                                                                                                                                                            + subst. rewrite nth_vinsert_eq; idx.
                                                                                                                                                                                                                                                                                                                                            + rewrite nth_vinsert_gt; idx.
                                                                                                                                                                                                                                                                                                                                        Qed.

                                                                                                                                                                                                                                                                                                                                        (*
  (** (a <<- x) = vzero -> x = Azero *)
  Lemma vinsert_eq0_imply_x0 {AeqDec : Dec (@eq A)} : forall {n} (v : @vec A n) i x,
      vinsert a i x = vzero -> x = Azero.
  Proof.
    intros. rewrite veq_iff in *. specialize (H i).
    rewrite nth_vzero in H. rewrite <- H.
    symmetry. apply nth_vinsert_eq.
  Qed.

  (** (a <<- x) = vzero -> a = vzero *)
  Lemma vinsert_eq0_imply_v0 {AeqDec : Dec (@eq A)} : forall {n} (v : @vec A n) i x,
      vinsert a i x = vzero -> a = vzero.
  Proof.
    intros.
    pose proof (vinsert_eq0_imply_x0 a i x H). subst.
    rewrite !veq_iff in *. intros j.
    destruct (j ??< i).
    - specialize (H (fin2SuccRange j)).
      rewrite nth_vinsert_lt with (j:=j) in H; auto.
    - destruct (j ??> i).
      + specialize (H (fin2SuccRangeSucc j)).
        rewrite nth_vinsert_gt with (j:=j) in H; auto. lia. idx.
      + assert (fin2nat i = fin2nat j). lia. rewrite nth_vzero.
        rewrite vinsert_eq_vinsert' in H.
        unfold vinsert',f2v,f2ff,v2f,ff2f in H.
        specialize (H (fin2SuccRangeSucc j)).
        destruct i as [i Hi], j as [j Hj]; simpl in *.
        rewrite nth_vzero in H. subst. idx. rewrite <- H. f_equal. idx.
  Qed.

  (** (a <<- x) = vzero <-> a = vzero /\ x = Azero  *)
  Lemma vinsert_eq0_iff {AeqDec : Dec (@eq A)} : forall {n} (v : @vec A n) i x,
      vinsert a i x = vzero <-> (a = vzero /\ x = Azero).
  Proof.
    intros. destruct (Aeqdec a vzero) as [Ha|Ha], (Aeqdec x Azero) as [Hx|Hx]; auto.
    - subst. split; intros; auto. apply vinsert_vzero_0.
    - subst. split; intros.
      + exfalso. rewrite veq_iff in H. specialize (H i).
        rewrite nth_vinsert_eq in H. cbv in H. easy.
      + destruct H. easy.
    - subst. split; intro.
      + split; auto. apply vinsert_eq0_imply_v0 in H; auto.
      + destruct H. subst. easy.
    - split; intros.
      + split. apply vinsert_eq0_imply_v0 in H; auto.
        apply vinsert_eq0_imply_x0 in H; auto.
      + destruct H; subst. apply vinsert_vzero_0.
  Qed.

  (** (a <<- x) <> vzero <-> a <> vzero \/ x <> Azero  *)
  Lemma vinsert_neq0_iff {AeqDec : Dec (@eq A)} : forall {n} (v : @vec A n) i x,
      vinsert a i x <> vzero <-> (a <> vzero \/ x <> Azero).
  Proof. intros. rewrite vinsert_eq0_iff. tauto. Qed.
                                                                                                                                                                                                                                                                                                                                         *)
                                                                                                                                                                                                                                                                                                                                        End vinsert.

                                                                                                                                                                                                                                                                                                                                        Section test.
                                                                                                                                                                                                                                                                                                                                          Let n := 5.
                                                                                                                                                                                                                                                                                                                                          Let a : vec n := l2v 9 [1;2;3;4;5].
                                                                                                                                                                                                                                                                                                                                          (* Compute v2l (vinsert a (nat2finS 1) 7). *)
                                                                                                                                                                                                                                                                                                                                          (* Compute v2l (vinsert a (nat2finS 5) 7). *)
                                                                                                                                                                                                                                                                                                                                        End test.    


                                                                                                                                                                                                                                                                                                                                        (*
(* ======================================================================= *)
(** ** Remove one element *)
Section vremove.
  Context {A} {Azero : A}.
  Notation v2f := (v2f Azero).

  (** Removes i-th element from vector `a` *)
  Definition vremove {n} (v : @vec A (S n)) (i : nat) : @vec A n :=
    fun j => if j ??< i
           then a (fin2SuccRange j)
           else a (fin2SuccRangeSucc j). 

  (* Another definition, which have simpler logic, but need `Azero`. *)
  Definition vremove' {n} (v : @vec A (S n)) (i : nat) : @vec A n :=
    f2v (fun j => if (j ??< fin2nat i) then v2f a j else v2f a (S j)).
  
  (* These two definitions are equivalent *)
  Lemma vremove_eq_vremove' : forall {n} (v : @vec A (S n)) (i : nat),
      vremove a i = vremove' a i.
  Proof.
    intros. apply veq_iff; intros j.
    unfold vremove, vremove', f2v, f2ff, v2f,ff2f.
    unfold fin2SuccRange, fin2SuccRangeSucc. erewrite nat2finS_eq.
    destruct i as [i Hi], j as [j Hj]; simpl. idx.
    Unshelve. pose proof (fin2nat_lt j). lia.
  Qed.

  (** j < i -> (vremove a i).j = v.j *)
  Lemma vremove_spec_lt : forall {n} (v : @vec A (S n)) (i : nat) (j : nat),
      j < fin2nat i -> v2f (vremove a i) j = v2f a j.
  Proof.
    intros. rewrite vremove_eq_vremove'. unfold v2f,vremove',f2v,f2ff,ff2f.
    destruct i as [i Hi]; simpl in *. idx.
  Qed.
  
  (** i <= j -> j < n -> (vremove a i).j = v.(S j) *)
  Lemma vremove_spec2 : forall {n} (v : @vec A (S n)) (i : nat) (j : nat),
      fin2nat i <= j -> j < n -> v2f (vremove a i) j = v2f a (S j).
  Proof.
    intros. rewrite vremove_eq_vremove'. unfold vremove',f2v,v2f,f2ff,ff2f.
    destruct i as [i Hi]; simpl in *. idx.
  Qed.

  (** j < i -> (vremove a i).j = a.j *)
  Lemma nth_vremove_lt : forall {n} (v : @vec A (S n)) (i : nat) (j : nat),
      fin2nat j < fin2nat i -> (vremove a i).[j = v2f a (fin2nat j).
  Proof.
    intros. rewrite vremove_eq_vremove'. unfold vremove',f2v,v2f,f2ff,ff2f.
    destruct i as [i Hi], j as [j Hj]; simpl in *. idx.
  Qed.
  
  (** i <= j -> j < n -> (vremove a i).j = a.(S j) *)
  Lemma nth_vremove_ge : forall {n} (v : @vec A (S n)) (i : nat) (j : nat),
      fin2nat i <= fin2nat j -> fin2nat j < n ->
      (vremove a i).[j = v2f a (S (fin2nat j)).
  Proof.
    intros. rewrite vremove_eq_vremove'. unfold vremove',f2v,v2f,f2ff,ff2f.
    destruct i as [i Hi], j as [j Hj]; simpl in *. idx.
  Qed.

  (** vremove (vinsert a i x) i = a *)
  Lemma vremove_vinsert : forall {n} (v : @vec A n) (i : nat) (x : A),
      vremove (vinsert a i x) i = a.
  Proof.
    intros. rewrite vremove_eq_vremove', (vinsert_eq_vinsert' (Azero:=Azero)).
    apply veq_iff; intros j.
    destruct i as [i Hi], j as [j Hj].
    unfold vremove',vinsert',f2v,v2f,f2ff,ff2f; simpl in *. idx.
  Qed.
  
  (** vinsert (vremove a i) (a.[i) = a *)
  Lemma vinsert_vremove : forall {n} (v : @vec A (S n)) (i : nat),
      vinsert (vremove a i) i (a.[i) = a.
  Proof.
    intros. rewrite vremove_eq_vremove', (vinsert_eq_vinsert' (Azero:=Azero)).
    apply veq_iff; intros j.
    destruct i as [i Hi], j as [j Hj].
    unfold vremove',vinsert',f2v,v2f,f2ff,ff2f; simpl in *. idx.
  Qed.
  
End vremove.

Section vmap_vinsert_vremove.
  Context {V1 V2 C : Type} {Azero : A} {Bzero : B} {Czero : C}.
  Context (f1 : A -> B).
  Context (f2 : A -> B -> C).

  (** vmap2 (vinsert a i x) b = vinsert (vmap2 a (vremove b i)) i (f x b.i) *)
  Lemma vmap2_vinsert_l : forall {n} (v : @vec A n) (b : @vec B (S n)) i (x : A),
      vmap2 f2 (vinsert a i x) b =
        vinsert (vmap2 f2 a (vremove b i)) i (f2 x (b$i)).
  Proof.
    intros. apply veq_iff; intros j. rewrite nth_vmap2.
    destruct (j ??< i) as [E|E].
    - assert (fin2nat j < n). pose proof (fin2nat_lt i). lia.
      rewrite (@nth_vinsert_lt _ Czero) with (j:=fin2PredRange j H); auto.
      + rewrite nth_vmap2. f_equal.
        * apply (@nth_vinsert_lt _ Azero). rewrite fin2nat_fin2PredRange. auto.
          rewrite fin2SuccRange_fin2PredRange; auto.
        * rewrite (nth_vremove_lt (Azero:=Bzero)); auto. simpl.
          assert (fin2nat j < S n) by lia.
          rewrite nth_v2f with (H:=H0). f_equal. rewrite nat2fin_fin2nat; auto.
      + rewrite fin2SuccRange_fin2PredRange; auto.
    - destruct (j ??= i).
      + assert (i = j). apply fin2nat_inj; auto. rewrite <- H.
        rewrite (@nth_vinsert_eq _ Azero).
        rewrite (@nth_vinsert_eq _ Czero). auto.
      + pose proof (fin2nat_lt i). pose proof (fin2nat_lt j).
        assert (0 < fin2nat j) by lia.
        rewrite (@nth_vinsert_gt _ Azero) with (j:=fin2PredRangePred j H1);
          simpl in *; try lia.
        2:{ rewrite fin2SuccRangeSucc_fin2PredRangePred; auto. }
        rewrite (@nth_vinsert_gt _ Czero) with (j:=fin2PredRangePred j H1);
          simpl in *; try lia.
        2:{ rewrite fin2SuccRangeSucc_fin2PredRangePred; auto. }
        rewrite nth_vmap2. f_equal.
        rewrite (@nth_vremove_ge _ Bzero); simpl in *; try lia.
        destruct j as [j Hj]. simpl.
        assert (S (pred j) < S n). lia. rewrite nth_v2f with (H:=H2). f_equal.
        apply fin_eq_iff. rewrite Nat.succ_pred_pos; auto.
  Qed.
  
  (** vmap2 a (vinsert b i x) = vinsert (vmap2 (vremove a i) b) i (f a.i x) *)
  Lemma vmap2_vinsert_r : forall {n} (v : @vec A (S n)) (b : @vec B n) i (x : B),
      vmap2 f2 a (vinsert b i x) =
        vinsert (vmap2 f2 (vremove a i) b) i (f2 (a$i) x).
  Proof.
    intros. apply veq_iff; intros j. rewrite nth_vmap2.
    destruct (j ??< i) as [E|E].
    - assert (fin2nat j < n). pose proof (fin2nat_lt i). lia.
      rewrite (@nth_vinsert_lt _ Czero) with (j:=fin2PredRange j H); auto.
      + rewrite nth_vmap2. f_equal.
        * rewrite (nth_vremove_lt (Azero:=Azero)); auto. simpl.
          assert (fin2nat j < S n) by lia.
          rewrite nth_v2f with (H:=H0). f_equal. rewrite nat2fin_fin2nat; auto.
        * apply (@nth_vinsert_lt _ Bzero). rewrite fin2nat_fin2PredRange. auto.
          rewrite fin2SuccRange_fin2PredRange; auto.
      + rewrite fin2SuccRange_fin2PredRange; auto.
    - destruct (j ??= i).
      + assert (i = j). apply fin2nat_inj; auto. rewrite <- H.
        rewrite (@nth_vinsert_eq _ Bzero).
        rewrite (@nth_vinsert_eq _ Czero). auto.
      + pose proof (fin2nat_lt i). pose proof (fin2nat_lt j).
        assert (0 < fin2nat j) by lia.
        rewrite (@nth_vinsert_gt _ Bzero) with (j:=fin2PredRangePred j H1);
          simpl in *; try lia.
        2:{ rewrite fin2SuccRangeSucc_fin2PredRangePred; auto. }
        rewrite (@nth_vinsert_gt _ Czero) with (j:=fin2PredRangePred j H1);
          simpl in *; try lia.
        2:{ rewrite fin2SuccRangeSucc_fin2PredRangePred; auto. }
        rewrite nth_vmap2. f_equal.
        rewrite (@nth_vremove_ge _ Azero); simpl in *; try lia.
        destruct j as [j Hj]. simpl.
        assert (S (pred j) < S n). lia. rewrite nth_v2f with (H:=H2). f_equal.
        apply fin_eq_iff. rewrite Nat.succ_pred_pos; auto.
  Qed.

  (** vmap f (vremove a i) = vremove (vmap f v) i *)
  Lemma vmap_vremove : forall {n} (v : @vec A (S n)) i,
      vmap f1 (vremove a i) = vremove (vmap f1 a) i.
  Proof.
    intros. apply veq_iff; intros j. rewrite nth_vmap.
    pose proof (fin2nat_lt i). pose proof (fin2nat_lt j).
    destruct (j ??< i).
    - rewrite (nth_vremove_lt (Azero:=Azero)); auto.
      rewrite (nth_vremove_lt (Azero:=Bzero)); auto.
      erewrite !nth_v2f. unfold vmap. auto.
    - rewrite (nth_vremove_ge (Azero:=Azero)); try lia.
      rewrite (nth_vremove_ge (Azero:=Bzero)); try lia.
      erewrite !nth_v2f. unfold vmap. auto.
      Unshelve. lia. lia.
  Qed.

  (** vmap2 f (vremove a i) (vremove b i) = vremove (vmap2 v1 v2) i *)
  Lemma vmap2_vremove_vremove : forall {n} (v : @vec A (S n)) (b : @vec B (S n)) i,
      vmap2 f2 (vremove a i) (vremove b i) = vremove (vmap2 f2 v1 v2) i.
  Proof.
    intros. apply veq_iff; intros j. rewrite nth_vmap2.
    pose proof (fin2nat_lt i). pose proof (fin2nat_lt j).
    destruct (j ??< i).
    - rewrite (nth_vremove_lt (Azero:=Azero)); auto.
      rewrite (nth_vremove_lt (Azero:=Bzero)); auto.
      rewrite (nth_vremove_lt (Azero:=Czero)); auto.
      erewrite !nth_v2f. rewrite nth_vmap2. auto.
    - rewrite (nth_vremove_ge (Azero:=Azero)); try lia.
      rewrite (nth_vremove_ge (Azero:=Bzero)); try lia.
      rewrite (nth_vremove_ge (Azero:=Czero)); try lia.
      erewrite !nth_v2f. rewrite nth_vmap2. auto.
      Unshelve. lia. lia.
  Qed.

End vmap_vinsert_vremove.


(* ======================================================================= *)
(** ** Get head or tail element *)
Section vhead_vtail.
  Context {A} {Azero : A}.

  (** Get head element *)
  Definition vhead {n} (v : @vec A (S n)) : A := a.[fin0.

  (** vhead a is = a.0 *)
  Lemma vhead_spec : forall {n} (v : @vec A (S n)), vhead a = (v2f Azero a) 0.
  Proof.
    intros. unfold vhead. erewrite nth_v2f. f_equal.
    apply fin_eq_iff; auto. Unshelve. lia.
  Qed.

  (** vhead a = a.[0 *)
  Lemma vhead_eq : forall {n} (v : @vec A (S n)), vhead a = a.[fin0.
  Proof. auto. Qed.

  
  (** Get tail element *)
  Definition vtail {n} (v : @vec A (S n)) : A := a.[(nat2finS n).

  (** vtail a = a.(n - 1) *)
  Lemma vtail_spec : forall {n} (v : @vec A (S n)), vtail a = (v2f Azero a) n.
  Proof.
    intros. unfold vtail. erewrite nth_v2f. erewrite nat2finS_eq. f_equal.
    Unshelve. lia.
  Qed.

  (** vtail a = a.[(n - 1) *)
  Lemma vtail_eq : forall {n} (v : @vec A (S n)), vtail a = a.[(nat2finS n).
  Proof.
    intros. rewrite vtail_spec. erewrite nth_v2f. erewrite nat2finS_eq. f_equal.
    Unshelve. all: lia.
  Qed.

End vhead_vtail.


(* ======================================================================= *)
(** ** Get head or tail elements *)
Section vheadN_vtailN.
  Context {A} {Azero : A}.

  (** Get head elements *)
  Definition vheadN {m n} (v : @vec A (m + n)) : @vec A m :=
    fun i => a.[(fin2AddRangeR i).

  (** i < m -> (vheadN a).i = (v2f a).i *)
  Lemma vheadN_spec : forall {m n} (v : @vec A (m + n)) i,
      i < m -> v2f Azero (vheadN a) i = (v2f Azero a) i.
  Proof.
    intros. unfold vheadN. erewrite !nth_v2f. f_equal.
    apply fin2nat_imply_nat2fin. simpl. auto.
    Unshelve. all: try lia.
  Qed.

  (** (vheadN a).i = a.i *)
  Lemma nth_vheadN : forall {m n} (v : @vec A (m + n)) i,
      (vheadN a).[i = a.[(fin2AddRangeR i).
  Proof. auto. Qed.

  
  (** Get tail elements *)
  Definition vtailN {m n} (v : @vec A (m + n)) : @vec A n :=
    fun i => a.[(fin2AddRangeAddL i).

  (** i < n -> (vtailN a).i = (v2f a).(m + i) *)
  Lemma vtailN_spec : forall {m n} (v : @vec A (m + n)) i,
      i < n -> v2f Azero (vtailN a) i = (v2f Azero a) (m + i).
  Proof.
    intros. unfold vtailN. erewrite !nth_v2f. f_equal.
    apply fin2nat_imply_nat2fin. simpl. auto.
    Unshelve. all: try lia.
  Qed.

  (** (vtailN a).i = a.(n + i) *)
  Lemma nth_vtailN : forall {m n} (v : @vec A (m + n)) i,
      (vtailN a).[i = a.[(fin2AddRangeAddL i).
  Proof. auto. Qed.

End vheadN_vtailN.


(* ======================================================================= *)
(** ** Remove exact one element at head or tail *)
Section vremoveH_vremoveT.
  Context {A} {Azero : A}.
  Notation v2f := (v2f Azero).
  Notation vzero := (vzero Azero).

  (** *** vremoveH *)
  
  (** Remove head element *)
  Definition vremoveH {n} (v : @vec A (S n)) : @vec A n :=
    fun i => a.[(fin2SuccRangeSucc i).

  (** i < n -> (vremoveH a).i = v.(S i) *)
  Lemma vremoveH_spec : forall {n} (v : @vec A (S n)) (i : nat),
      i < n -> v2f (vremoveH a) i = v2f a (S i).
  Proof.
    intros. unfold vremoveH,v2f,ff2f. idx. apply fin_eq_iff; auto.
  Qed.
  
  (** (vremoveH a).i = a.(S i) *)
  Lemma nth_vremoveH : forall {n} (v : @vec A (S n)) (i : nat),
      (vremoveH a).[i = a.[(fin2SuccRangeSucc i).
  Proof. intros. unfold vremoveH. auto. Qed.
  
  (** a <> 0 -> vhead a = 0 -> vremoveH a <> 0 *)
  Lemma vremoveH_neq0_if : forall {n} (v : @vec A (S n)),
      a <> vzero -> vhead a = Azero -> vremoveH a <> vzero.
  Proof.
    intros. intro. destruct H. apply veq_iff; intros.
    rewrite veq_iff in H1. unfold vremoveH in H1. rewrite vhead_eq in H0.
    destruct (fin2nat i ??= 0) as [E|E].
    - destruct i; simpl in *; subst. rewrite nth_vzero. f_equal.
      apply fin_eq_iff; auto.
    - assert (0 < fin2nat i). pose proof (fin2nat_lt i). lia.
      specialize (H1 (fin2PredRangePred i H)).
      rewrite fin2SuccRangeSucc_fin2PredRangePred in H1. rewrite H1. cbv. auto.
  Qed.

  (** vremoveH also hold, if hold for all elements *)
  Lemma vremoveH_hold : forall {n} (v : @vec A (S n)) (P : A -> Prop),
      (forall i, P (a.[i)) -> (forall i, P ((vremoveH a).[i)).
  Proof. intros. unfold vremoveH. auto. Qed.

  
  (** *** vremoveT *)

  (** Remove tail element *)
  Definition vremoveT {n} (v : @vec A (S n)) : @vec A n :=
    fun i => a.[(fin2SuccRange i).

  (** i < n -> (vremoveT a).i = a.i *)
  Lemma vremoveT_spec : forall {n} (v : @vec A (S n)) (i : nat),
      i < n -> v2f (vremoveT a) i = v2f a i.
  Proof.
    intros. unfold vremoveT,v2f,ff2f. idx.
    erewrite fin2SuccRange_nat2fin. apply fin_eq_iff; auto.
    Unshelve. auto.
  Qed.
  
  (** (vremoveT a).i = a.i *)
  Lemma nth_vremoveT : forall {n} (v : @vec A (S n)) (i : nat),
      (vremoveT a).[i = a.[(fin2SuccRange i).
  Proof. intros. unfold vremoveT. auto. Qed.
  
  (** v <> 0 -> vtail v = 0 -> vremoveT v <> 0 *)
  Lemma vremoveT_neq0_if : forall {n} (v : @vec A (S n)),
      a <> vzero -> vtail a = Azero -> vremoveT a <> vzero.
  Proof.
    intros. intro. destruct H. apply veq_iff; intros.
    rewrite veq_iff in H1. unfold vremoveT in H1.
    rewrite (vtail_eq (Azero:=Azero)) in H0.
    destruct (fin2nat i ??= n) as [E|E].
    - destruct i; simpl in *; subst. rewrite nth_vzero. f_equal.
      erewrite nat2finS_eq. apply fin_eq_iff; auto.
    - assert (fin2nat i < n). pose proof (fin2nat_lt i). lia.
      specialize (H1 (fin2PredRange i H)).
      rewrite fin2SuccRange_fin2PredRange in H1. rewrite H1. cbv. auto.
      Unshelve. auto.
  Qed.

  (** vremoveT also hold, if hold for all elements *)
  Lemma vremoveT_hold : forall {n} (v : @vec A (S n)) (P : A -> Prop),
      (forall i, P (a.[i)) -> (forall i, P ((vremoveT a).[i)).
  Proof. intros. unfold vremoveT. auto. Qed.

End vremoveH_vremoveT.


(* ======================================================================= *)
(** ** Remove elements at head or tail *)
Section vremoveHN_vremoveTN.
  Context {A} {Azero : A}.
  Notation v2f := (v2f Azero).
  Notation vzero := (vzero Azero).

  (** *** vremoveHN *)
  
  (** Remove head elements *)
  Definition vremoveHN {m n} (v : @vec A (m + n)) : @vec A n :=
    fun i => a.[(fin2AddRangeAddL i).

  (** i < n -> (vremoveHN a).i = a.(m + i) *)
  Lemma vremoveHN_spec : forall {m n} (v : @vec A (m + n)) (i : nat),
      i < n -> v2f (vremoveHN a) i = v2f a (m + i).
  Proof.
    intros. unfold vremoveHN. erewrite !nth_v2f. f_equal.
    apply fin2nat_imply_nat2fin; simpl. auto.
    Unshelve. all: lia.
  Qed.
  
  (** (vremoveHN a).i = a.(m + i) *)
  Lemma nth_vremoveHN : forall {m n} (v : @vec A (m + n)) (i : nat),
      (vremoveHN a).[i = a.[(fin2AddRangeAddL i).
  Proof. auto. Qed.
  
  (** a <> 0 -> vheadN v = 0 -> vremoveHN a <> 0 *)
  Lemma vremoveHN_neq0_if : forall {m n} (v : @vec A (m + n)),
      a <> vzero -> vheadN a = vzero -> vremoveHN a <> vzero.
  Proof.
    intros. intro.
    rewrite veq_iff in H0. unfold vheadN in H0.
    rewrite veq_iff in H1. unfold vremoveHN in H1.
    destruct H. apply veq_iff; intros.
    destruct (m ??<= fin2nat i) as [E|E].
    - specialize (H1 (fin2AddRangeAddL' i E)).
      rewrite fin2AddRangeAddL_fin2AddRangeAddL' in H1. rewrite H1. cbv. auto.
    - assert (fin2nat i < m). lia.
      specialize (H0 (fin2AddRangeR' i H)).
      rewrite fin2AddRangeR_fin2AddRangeR' in H0. rewrite H0. cbv. auto.
  Qed.
  
  
  (** *** vremoveTN *)

  (** Remove tail elements *)
  Definition vremoveTN {m n} (v : @vec A (m + n)) : @vec A m :=
    fun i => a.[(fin2AddRangeR i).

  (** i < n -> (vremoveTN a).i = a.i *)
  Lemma vremoveTN_spec : forall {m n} (v : @vec A (m + n)) (i : nat),
      i < m -> v2f (vremoveTN a) i = v2f a i.
  Proof.
    intros. unfold vremoveTN,v2f,ff2f. idx. apply fin_eq_iff; auto.
  Qed.
  
  (** (vremoveTN a).i = a.i *)
  Lemma nth_vremoveTN : forall {m n} (v : @vec A (m + n)) (i : fin m),
      (vremoveTN a).[i = a.[(fin2AddRangeR i).
  Proof. intros. auto. Qed.
  
  (** a <> 0 -> vtailN v = 0 -> vremoveTN a <> 0 *)
  Lemma vremoveTN_neq0_if : forall {m n} (v : @vec A (m + n)),
      a <> vzero -> vtailN a = vzero -> vremoveTN a <> vzero.
  Proof.
    intros. intro.
    rewrite veq_iff in H0. unfold vtailN in H0.
    rewrite veq_iff in H1. unfold vremoveTN in H1.
    destruct H. apply veq_iff; intros.
    destruct (m ??<= fin2nat i) as [E|E].
    - specialize (H0 (fin2AddRangeAddL' i E)).
      rewrite fin2AddRangeAddL_fin2AddRangeAddL' in H0. rewrite H0. cbv. auto.
    - assert (fin2nat i < m). lia.
      specialize (H1 (fin2AddRangeR' i H)).
      rewrite fin2AddRangeR_fin2AddRangeR' in H1. rewrite H1. cbv. auto.
  Qed.

End vremoveHN_vremoveTN.


(* ======================================================================= *)
(** ** Construct vector with one element at the head or tail position *)
Section vconsH_vconsT.
  Context {A} {Azero : A}.
  Notation v2f := (v2f Azero).
  Notation vzero := (vzero Azero).

  (** *** vconsH *)

  (** cons at head: [x; a] *)
  Definition vconsH {n} (x : A) (v : @vec A n) : @vec A (S n).
    intros i. destruct (fin2nat i ??= 0). exact x.
    assert (0 < fin2nat i). apply neq_0_lt_stt; auto.
    apply (a.[(fin2PredRangePred i H)).
  Defined.

  (** i = 0 -> (v2f [x; a]) i = a *)
  Lemma vconsH_spec_0 : forall {n} x (v : @vec A n) (i : nat),
      i = 0 -> v2f (vconsH x a) i = x.
  Proof.
    intros. subst. unfold vconsH,v2f,ff2f; simpl. auto.
  Qed.

  (** 0 < i -> i < n -> [x; a].i = a.(pred i) *)
  Lemma vconsH_spec_gt0 : forall {n} x (v : @vec A n) (i : nat),
      0 < i -> i < n -> v2f (vconsH x a) i = v2f a (pred i).
  Proof.
    intros. unfold vconsH,v2f,ff2f; simpl. idx. apply fin_eq_iff; auto.
  Qed.

  (** i = 0 -> [x; a].i = a *)
  Lemma nth_vconsH_0 : forall {n} x (v : @vec A n) i,
      i = fin0 -> (vconsH x a).[i = x.
  Proof. intros. subst. unfold vconsH. simpl. auto. Qed.
  
  (** 0 < i -> [x; a].i = a.(pred i)  *)
  Lemma nth_vconsH_gt0 : forall {n} x (v : @vec A n) i (H: 0 < fin2nat i),
      (vconsH x a).[i = a.[(fin2PredRangePred i H).
  Proof.
    intros. unfold vconsH. idx. apply proof_irrelevance.
  Qed.

  (** [x; a] = 0 <-> x = 0 /\ v = 0 *)
  Lemma vconsH_eq0_iff : forall {n} x (v : @vec A n),
      vconsH x a = vzero <-> x = Azero /\ a = vzero.
  Proof.
    intros. rewrite !veq_iff. split; intros.
    - split; intros; auto.
      + specialize (H fin0). rewrite nth_vconsH_0 in H; auto.
      + specialize (H (fin2SuccRangeSucc i)). rewrite nth_vzero in *. rewrite <- H.
        erewrite nth_vconsH_gt0. f_equal.
        rewrite fin2PredRangePred_fin2SuccRangeSucc. auto.
    - destruct H. subst. destruct (fin2nat i ??= 0).
      + rewrite nth_vconsH_0; auto. destruct i; simpl in *. apply fin_eq_iff; auto.
      + erewrite nth_vconsH_gt0; auto.
        Unshelve. rewrite fin2nat_fin2SuccRangeSucc. lia. lia.
  Qed.
  
  (** [x; a] <> 0 <-> x <> 0 \/ a <> 0 *)
  Lemma vconsH_neq0_iff : forall {n} x (v : @vec A n),
      vconsH x a <> vzero <-> x <> Azero \/ a <> vzero.
  Proof. intros. rewrite vconsH_eq0_iff. tauto. Qed.

  (** vconsH (vhead a) (vremoveH a) = a *)
  Lemma vconsH_vhead_vremoveH : forall {n} (v : @vec A (S n)),
      vconsH (vhead a) (vremoveH a) = a.
  Proof.
    intros. apply veq_iff; intros. destruct (fin2nat i ??= 0).
    - rewrite nth_vconsH_0. 
      + unfold vhead. f_equal. destruct i; simpl in *; auto. apply fin_eq_iff; auto.
      + destruct i; simpl in *. apply fin_eq_iff; auto.
    - erewrite nth_vconsH_gt0. rewrite nth_vremoveH. f_equal.
      rewrite fin2SuccRangeSucc_fin2PredRangePred. auto.
      Unshelve. lia.
  Qed.

  (** vremoveH (vconsH a x) = a *)
  Lemma vremoveH_vconsH : forall {n} x (v : @vec A n), vremoveH (vconsH x a) = a.
  Proof.
    intros. apply veq_iff; intros i. rewrite nth_vremoveH.
    erewrite nth_vconsH_gt0. f_equal. apply fin2PredRangePred_fin2SuccRangeSucc.
    Unshelve. rewrite fin2nat_fin2SuccRangeSucc. lia.
  Qed.
  
  (** vhead (vconsH a x) = x *)
  Lemma vhead_vconsH : forall {n} (v : @vec A n) x, vhead (vconsH x a) = x.
  Proof. intros. unfold vhead. rewrite nth_vconsH_0; auto. Qed.

  (** [0; vzero] = vzero *)
  Lemma vconsH_0_vzero : forall {n}, @vconsH n Azero vzero = vzero.
  Proof. intros. unfold vconsH. apply veq_iff; intros. idx. Qed.
  
  
  (** *** vconsT *)

  (** cons at tail: [a; x] *)
  Definition vconsT {n} (v : @vec A n) (x : A) : @vec A (S n).
    intros i. destruct (fin2nat i ??< n) as [E|E].
    - apply (a.[(fin2PredRange i E)).
    - apply x.
  Defined.
  
  (** i = n -> (v2f [a; x]) i = a *)
  Lemma vconsT_spec_n : forall {n} x (v : @vec A n) (i : nat),
      i = n -> v2f (vconsT a x) i = x.
  Proof. intros. subst. unfold vconsT,v2f,ff2f; simpl. idx. Qed.

  (** i < n -> (v2f [a; x]) i = a.(pred i) *)
  Lemma vconsT_spec_lt : forall {n} x (v : @vec A n) (i : nat),
      i < n -> v2f (vconsT a x) i = v2f a i.
  Proof. intros. unfold vconsT,v2f,ff2f; simpl. idx. Qed.

  (** i = n -> [a; x].i = a *)
  Lemma nth_vconsT_n : forall {n} x (v : @vec A n) i,
      fin2nat i = n -> (vconsT a x).[i = x.
  Proof. intros. unfold vconsT. idx. Qed.

  (** i < n -> [a; x].i = a.(pred i) *)
  Lemma nth_vconsT_lt : forall {n} x (v : @vec A n) i (H: fin2nat i < n),
      (vconsT a x).[i = a (fin2PredRange i H).
  Proof. intros. unfold vconsT. idx. Qed.

  (** [a; x] = 0 <-> a = 0 /\ x = 0*)
  Lemma vconsT_eq0_iff : forall {n} (v : @vec A n) x,
      vconsT a x = vzero <-> a = vzero /\ x = Azero.
  Proof.
    intros. rewrite !veq_iff. split; intros.
    - split; intros; auto.
      + specialize (H (fin2SuccRange i)). rewrite nth_vzero in *. rewrite <- H.
        erewrite nth_vconsT_lt. f_equal.
        rewrite fin2PredRange_fin2SuccRange. auto.
      + specialize (H (nat2finS n)). rewrite nth_vconsT_n in H; auto.
        rewrite fin2nat_nat2finS; auto.
    - pose proof (fin2nat_lt i).
      destruct H. subst. destruct (fin2nat i ??= n).
      + rewrite nth_vconsT_n; auto.
      + erewrite nth_vconsT_lt; auto.
        Unshelve. all: try lia. rewrite fin2nat_fin2SuccRange. apply fin2nat_lt.
  Qed.
  
  (** [a; x] <> 0 <-> a <> 0 \/ x <> 0*)
  Lemma vconsT_neq0_iff : forall {n} (v : @vec A n) x,
      vconsT a x <> vzero <-> a <> vzero \/ x <> Azero.
  Proof.
    intros. rewrite vconsT_eq0_iff. split; intros.
    apply not_and_or in H; auto. apply or_not_and; auto.
  Qed.

  (** vconsT (vremoveT a) (vtail a) = a *)
  Lemma vconsT_vremoveT_vtail : forall {n} (v : @vec A (S n)),
      vconsT (vremoveT a) (vtail a) = a.
  Proof.
    intros. apply veq_iff; intros. destruct (fin2nat i ??= n).
    - destruct i as [i Hi]. simpl in *. subst. rewrite nth_vconsT_n; auto.
      rewrite (vtail_eq (Azero:=Azero)). f_equal. erewrite nat2finS_eq.
      apply fin_eq_iff; auto.
    - erewrite nth_vconsT_lt. rewrite nth_vremoveT. f_equal.
      rewrite fin2SuccRange_fin2PredRange. auto.
      Unshelve. all: try lia. pose proof (fin2nat_lt i). lia.
  Qed.

  (** vremoveT (vconsT a x) = a *)
  Lemma vremoveT_vconsT : forall {n} (v : @vec A n) x, vremoveT (vconsT a x) = a.
  Proof.
    intros. apply veq_iff; intros i. rewrite nth_vremoveT.
    erewrite nth_vconsT_lt. f_equal. apply fin2PredRange_fin2SuccRange.
    Unshelve. rewrite fin2nat_fin2SuccRange. apply fin2nat_lt.
  Qed.
  
  (** vtail (vconsT a x) = x *)
  Lemma vtail_vconsT : forall {n} (v : @vec A n) x, vtail (vconsT a x) = x.
  Proof.
    intros. unfold vtail. rewrite nth_vconsT_n; auto.
    rewrite fin2nat_nat2finS; auto.
  Qed.

  (** [vzero; 0] = vzero *)
  Lemma vconsT_vzero_0 : forall {n}, @vconsT n vzero Azero = vzero.
  Proof.
    intros. unfold vconsT. apply veq_iff; intros. idx.
  Qed.
  
End vconsH_vconsT.


(* ======================================================================= *)
(** ** Construct vector with two vectors *)
Section vapp.
  Context {A} {Azero : A}.
  Notation vzero := (vzero Azero).

  (** Append two vectors, denoted with a@b *)
  Definition vapp {m n} (v : @vec A m) (b : @vec A n) : @vec A (m + n).
    intros i. destruct (fin2nat i ??< m) as [E|E].
    - exact (a.[(fin2AddRangeR' i E)).
    - assert (m <= fin2nat i). apply Nat.nlt_ge; auto.
      exact (b.[(fin2AddRangeAddL' i H)).
  Defined.
  
  (** i < m -> a@b.i = u.i *)
  Lemma vapp_spec_L : forall {m n} (v : @vec A m) (b : @vec A n) (i : nat),
      i < m -> v2f Azero (vapp v1 v2) i = v2f Azero a i.
  Proof.
    intros. unfold vapp.
    assert (i < m + n). lia.
    rewrite nth_v2f with (H:=H0). rewrite nth_v2f with (H:=H). idx.
    apply fin_eq_iff; auto.
  Qed.
  
  (** m <= i -> i < m + n -> a&b.i = a.(i - m) *)
  Lemma vapp_spec_R : forall {m n} (v : @vec A m) (b : @vec A n) (i : nat),
      m <= i -> i < m + n -> v2f Azero (vapp v1 v2) i = v2f Azero b (i - m).
  Proof.
    intros. unfold vapp.
    rewrite nth_v2f with (H:=H0). simpl. idx.
    assert (i - m < n). lia. rewrite nth_v2f with (H:=H1). f_equal.
    apply fin_eq_iff; auto.
  Qed.
  
  (** i < m -> a&b.i = a.i *)
  Lemma nth_vapp_L : forall {m n} (v : @vec A m) (b : @vec A n) i (H: fin2nat i < m),
      (vapp v1 v2).[i = a.[(fin2AddRangeR' i H).
  Proof.
    intros. destruct i as [i Hi]. unfold vapp. simpl. idx.
  Qed.
  
  (** m <= i -> a&b.i = b.i *)
  Lemma nth_vapp_R : forall {m n} (v : @vec A m) (b : @vec A n) i (H : m <= fin2nat i),
      (vapp v1 v2).[i = b.[(fin2AddRangeAddL' i H).
  Proof.
    intros. destruct i as [i Hi]. unfold vapp. simpl in *. idx.
    apply proof_irrelevance.
  Qed.

  (** a@b = 0 <-> a = 0 /\ b = 0 *)
  Lemma vapp_eq0_iff : forall {m n} (v : @vec A m) (b : @vec A n),
      vapp v1 v2 = vzero <-> a = vzero /\ b = vzero.
  Proof.
    intros. rewrite !veq_iff. split; intros.
    - split; intros.
      + specialize (H (fin2AddRangeR i)).
        erewrite nth_vapp_L in H. rewrite fin2AddRangeR'_fin2AddRangeR in H.
        rewrite H. cbv. auto.
      + specialize (H (fin2AddRangeAddL i)).
        erewrite nth_vapp_R in H. erewrite fin2AddRangeAddL'_fin2AddRangeAddL in H.
        rewrite H. cbv. auto.
    - destruct H. destruct (fin2nat i ??< m) as [E|E].
      + rewrite nth_vapp_L with (H:=E). rewrite H. cbv. auto.
      + erewrite nth_vapp_R. rewrite H0. cbv. auto.
        Unshelve. all: try lia.
        * rewrite fin2nat_fin2AddRangeR. apply fin2nat_lt.
        * rewrite fin2nat_fin2AddRangeAddL. lia.
  Qed.
  
  (** vapp (vheadN a) (vtailN a) = a *)
  Lemma vapp_vheadN_vtailN : forall {m n} (v : @vec A (m + n)),
      vapp (vheadN a) (vtailN a) = a.
  Proof.
    intros. apply veq_iff; intros.
    destruct (fin2nat i ??< m) as [E|E].
    - erewrite nth_vapp_L. rewrite nth_vheadN.
      rewrite fin2AddRangeR_fin2AddRangeR'. auto.
    - erewrite nth_vapp_R. rewrite nth_vtailN.
      rewrite fin2AddRangeAddL_fin2AddRangeAddL'. auto.
      Unshelve. auto. lia.
  Qed.

End vapp.

Section vapp_extra.
  Context {V1 V2 C : Type}.

  (* map2 a@b c@d = (map2 a c) @ (map2 b d) *)
  Lemma vmap2_vapp_vapp :
    forall {n m} (f : A -> B -> C)
           (v : @vec A n) (b : @vec A m) (c : @vec B n) (d : @vec B m),
      vmap2 f (vapp v1 v2) (vapp c d) = vapp (vmap2 f a c) (vmap2 f b d).
  Proof.
    intros. unfold vmap2. apply veq_iff. intros.
    destruct (fin2nat i ??< n).
    - erewrite !nth_vapp_L. auto.
    - erewrite !nth_vapp_R. auto.
      Unshelve. auto. lia.
  Qed.

End vapp_extra.


(* ======================================================================= *)
(** ** Construct vector from parts of a vector *)
Section vslice.
  Context {A} {Azero : A}.

  (** {i<n}, {j<n}, {k:=S j-i} -> {i+k < n} *)
  Definition vslice_idx {n} (i j : nat)
    (k : fin (S (fin2nat j) - (fin2nat i))) : nat.
    refine (nat2fin (fin2nat i + fin2nat k) _).
    pose proof (fin2nat_lt k). pose proof (fin2nat_lt j).
    apply nat_lt_sub_imply_lt_add in H. rewrite commutative.
    apply nat_ltS_lt_lt with (b := fin2nat j); auto.
  Defined.
  
  (** Get a slice from vector `v` which contain elements from v$i to v$j.
      1. Include the i-th and j-th element
      2. If i > i, then the result is `vec 0` *)
  Definition vslice {n} (v : @vec A n) (i j : nat) :
    @vec A (S (fin2nat j) - (fin2nat i)) :=
    fun k => a.[(vslice_idx i j k).

  Lemma nth_vslice : forall {n} (v : @vec A n) (i j : nat) k,
      (vslice a i j).[k = a.[(vslice_idx i j k).
  Proof. intros. auto. Qed.
  
End vslice.

Section test.
  Let n := 5.
  Let a : vec n := l2v 9 [1;2;3;4;5].
  (* Compute v2l (vslice a (nat2finS 1) (nat2finS 3)). *)
End test.




(* ======================================================================= *)
(** ** A proposition which all elements of the vector hold *)
Section vforall.
  Context {A : Type}.

  (** Every element of `a` satisfy the `P` *)
  Definition vforall {n} (v : @vec A n) (P : A -> Prop) : Prop := forall i, P (a.[i).
  
End vforall.


(* ======================================================================= *)
(** ** A proposition which at least one element of the vector holds *)
Section vexist.
  Context {A : Type}.

  (** There exist element of `v` satisfy the `P` *)
  Definition vexist {n} (v : @vec A n) (P : A -> Prop) : Prop := exists i, P (a.[i).
  
End vexist.


(* ======================================================================= *)
(** ** An element belongs to the vector *)
Section vmem.
  Context {A : Type}.

  (** Element `x` belongs to the vector `a` *)
  Definition vmem {n} (v : @vec A n) (x : A) : Prop := vexist a (fun x0 => x0 = x).

  Lemma vmem_vnth : forall {n} (v : @vec A n) (i : nat), vmem a (a$i).
  Proof. intros. hnf. exists i; auto. Qed.

  (* If we have AeqDec *)
  Section AeqDec.
    Context {AeqDec : Dec (@eq A)}.
    
    (** {x ∈ a} + {x ∉ a} *)
    Lemma vmem_dec : forall {n} (v : @vec A n) (x : A), {vmem a x} + {~vmem a x}.
    Proof.
      intros. unfold vmem, vexist. induction n.
      - right. intro. destruct H. apply fin0_False; auto.
      - rewrite <- (vconsH_vhead_vremoveH a).
        destruct (Aeqdec (vhead a) x) as [H|H].
        + left. exists fin0. rewrite nth_vconsH_0; auto.
        + destruct (IHn (vremoveH a)) as [H1|H1].
          * left. destruct H1 as [i H1]. exists (fin2SuccRangeSucc i).
            erewrite nth_vconsH_gt0.
            rewrite fin2PredRangePred_fin2SuccRangeSucc. auto.
          * right. intro. destruct H1. destruct H0 as [i H0].
            destruct (fin2nat i ??= 0).
            ** rewrite nth_vconsH_0 in H0; auto; try easy.
               destruct i; simpl in *; apply fin_eq_iff; auto.
            ** erewrite nth_vconsH_gt0 in H0.
               eexists (fin2PredRangePred i _). apply H0.
               Unshelve. all: try lia. rewrite fin2nat_fin2SuccRangeSucc. lia.
    Qed.
    
  End AeqDec.
  
End vmem.


(* ======================================================================= *)
(** ** An vector belongs to another vector *)
Section vmems.
  Context {A : Type}.

  (** Every element of vector `a` belongs to vector `b` *)
  Definition vmems {r s} (v : @vec A r) (b : @vec A s) : Prop :=
    vforall a (fun x => vmem b x).

  Lemma vmems_refl : forall {n} (v : @vec A n), vmems a a.
  Proof. intros. unfold vmems, vforall. apply vmem_vnth. Qed.

  Lemma vmems_trans : forall {r s t} (v : @vec A r) (b : @vec A s) (c : @vec A t),
      vmems v1 v2 -> vmems b c -> vmems a c.
  Proof.
    intros. unfold vmems, vforall in *. intros.
    specialize (H i). destruct H as [j H]. rewrite <- H. auto.
  Qed.

  (* If we have AeqDec *)
  Section AeqDec.
    Context {AeqDec : Dec (@eq A)}.

    (** {a ⊆ b} + {~(a ⊆ b)} *)
    Lemma vmems_dec : forall {r s} (v : @vec A r) (b : @vec A s),
        {vmems v1 v2} + {~vmems v1 v2}.
    Proof.
      intros. unfold vmems, vforall. induction r.
      - left. intro. exfalso. apply fin0_False; auto.
      - rewrite <- (vconsH_vhead_vremoveH a).
        specialize (IHr (vremoveH a)). destruct IHr as [H|H].
        + destruct (vmem_dec b (vhead a)) as [H1|H1].
          * left. intros. destruct (fin2nat i ??= 0).
          ** rewrite nth_vconsH_0; auto.
               destruct i; simpl in *; apply fin_eq_iff; auto.
            ** erewrite nth_vconsH_gt0; auto.
            * right. apply ex_not_not_all. exists fin0. rewrite nth_vconsH_0; auto.
        + right. intro. destruct H. intro.
          specialize (H0 (fin2SuccRangeSucc i)).
          assert (0 < fin2nat (fin2SuccRangeSucc i)).
          apply fin2nat_fin2SuccRangeSucc_gt0.
          rewrite nth_vconsH_gt0 with (H:=H) in H0.
          rewrite fin2PredRangePred_fin2SuccRangeSucc in H0. auto.
          Unshelve. lia.
    Qed.
    
  End AeqDec.
  
End vmems.


(* ======================================================================= *)
(** ** Two vectors are equivalent (i.e., contain each other) *)
Section vequiv.
  Context {A : Type}.

  (** Two vectors are equivalent (i.e., contain each other) *)
  Definition vequiv {r s} (v : @vec A r) (b : @vec A s) : Prop :=
    vmems v1 v2 /\ vmems v2 v1.

  Lemma vequiv_refl : forall {n} (v : @vec A n), vequiv a a.
  Proof. intros. unfold vequiv. split; apply vmems_refl. Qed.
  
  Lemma vequiv_syms : forall {r s} (v : @vec A r) (b : @vec A s), vequiv v1 v2 -> vequiv v2 v1.
  Proof. intros. unfold vequiv in *. tauto. Qed.
  
  Lemma vequiv_trans : forall {r s t} (v : @vec A r) (b : @vec A s) (c : @vec A t),
      vequiv v1 v2 -> vequiv b c -> vequiv a c.
  Proof.
    intros. unfold vequiv in *. destruct H as [H1 H2], H0 as [H3 H4]. split.
    apply vmems_trans with b; auto.
    apply vmems_trans with b; auto.
  Qed.

  (* If we have AeqDec *)
  Section AeqDec.
    Context {AeqDec : Dec (@eq A)}.

    (** {a ∼ b} + {~(a ∼ b)} *)
    Lemma vequiv_dec : forall {r s} (v : @vec A r) (b : @vec A s),
        {vequiv v1 v2} + {~ vequiv v1 v2}.
    Proof.
      intros. unfold vequiv. destruct (vmems_dec v1 v2), (vmems_dec v2 v1); try tauto.
    Qed.
  End AeqDec.
  
End vequiv.

Section test.

  Let a : vec 2 := l2v 9 [1;2].
  Let b : vec 3 := l2v 9 [1;2;1].
  Example vequiv_example1 : vequiv v1 v2.
  Proof.
    unfold a, b, vequiv, vmems, vmem, vforall, vexist. split.
    - intros. destruct i as [i Hi].
      repeat (destruct i; try lia); try rewrite nth_l2v; simpl.
      exists (nat2finS 0); auto.
      exists (nat2finS 1); auto.
    - intros. destruct i as [i Hi].
      repeat (destruct i; try lia); try rewrite nth_l2v; simpl.
      exists (nat2finS 0); auto.
      exists (nat2finS 1); auto.
      exists (nat2finS 0); auto.
  Qed.
End test.


(* (* ======================================================================= *) *)
(* (** ** An vector belongs to one but not belong to another *) *)
(* Section vdiff. *)
(*   Context {A : Type}. *)

(*   (** Elements belong to vector `u` but not belongs to vector `v` *) *)
(*   Definition vdiff {r s} (v : @vec A r) (b : @vec A s) : Prop. *)
(*     Check fun i => vmem  *)
(*     vforall a (fun x => vmem b x). *)

(* End vmems. *)



(* ======================================================================= *)
(** ** Folding of a vector *)
Section vfold.
  Context {V1 V2 : Type} {Azero : A} {Bzero : B}. 

  (** ((x + a.1) + a.2) + ... *)
  Definition vfoldl {n} (v : @vec A n) (x : B) (f : B -> A -> B) : B :=
    seqfoldl (ff2f (Azero:=Azero) a) n x f.
  
  (** ... + (v.(n-1) + (v.n + x)) *)
  Definition vfoldr {n} (v : @vec A n) (x : B) (f : A -> B -> B) : B :=
    seqfoldr (ff2f (Azero:=Azero) a) n x f.

  (** Convert `vfoldl` to `seqfoldl` *)
  Lemma vfoldl_eq_seqfoldl :
    forall {n} (v : @vec A n) (x : B) (f : B -> A -> B) (s : nat -> A),
      (forall i, a.[i = s (fin2nat i)) -> vfoldl a x f = seqfoldl s n x f.
  Proof.
    intros. unfold vfoldl. apply seqfoldl_eq; auto.
    intros. rewrite nth_ff2f with (E:=H0). rewrite H.
    rewrite fin2nat_nat2fin. auto.
  Qed.

End vfold.

                                                                                                                                                                                                                                                                                                                                         *)
                                                                                                                                                                                                                                                                                                                                        (* ======================================================================= *)
                                                                                                                                                                                                                                                                                                                                        (** ** Sum of a vector *)
                                                                                                                                                                                                                                                                                                                                        Section vsum.
                                                                                                                                                                                                                                                                                                                                          Context `{HAMonoid : AMonoid}.
                                                                                                                                                                                                                                                                                                                                          Infix "+" := Aadd : A_scope.
                                                                                                                                                                                                                                                                                                                                          Notation "0" := Azero : A_scope.
                                                                                                                                                                                                                                                                                                                                          Notation seqsum := (@seqsum _ Aadd 0).

                                                                                                                                                                                                                                                                                                                                          (** ∑a = a.0 + a.1 + ... + a.(n-1) *)
                                                                                                                                                                                                                                                                                                                                          Definition vsum {n} (v : @vec A n) := seqsum (v2f a) n.

                                                                                                                                                                                                                                                                                                                                        (*
  (** (∀ i, a.i = b.i) -> Σa = Σb *)
  Lemma vsum_eq : forall {n} (v1 v2 : @vec A n), (forall i, a.[i = b.[i) -> vsum a = vsum b.
  Proof. intros. apply fseqsum_eq. auto. Qed.

  (** (∀ i, a.i = 0) -> Σa = 0 *)
  Lemma vsum_eq0 : forall {n} (v : @vec A n), (forall i, a.[i = 0) -> vsum a = 0.
  Proof. intros. unfold vsum. apply fseqsum_eq0. auto. Qed.

  (** Convert `vsum` to `seqsum` *)
  Lemma vsum_eq_seqsum : forall {n} (v : @vec A n) (g : nat -> A),
      (forall i, a.[i = g (fin2nat i)) -> vsum a = seqsum g n.
  Proof. intros. apply fseqsum_eq_seqsum; auto. Qed.

  (** Convert `vsum` to `seqsum` (succ form) *)
  Lemma vsum_eq_seqsum_succ : forall {n} (v : @vec A (S n)),
      vsum a = seqsum (fun i => a.[(nat2finS i)) n + a.[(nat2finS n).
  Proof. intros. apply fseqsum_eq_seqsum_succ. Qed.
  
  (** `vsum` of (S n) elements, equal to addition of Sum and tail *)
  Lemma vsumS_tail : forall {n} (v : @vec A (S n)),
      vsum a = vsum (fun i => a.[(fin2SuccRange i)) + a.[(nat2finS n).
  Proof. intros. apply fseqsumS_tail; auto. Qed.

  (** `vsum` of (S n) elements, equal to addition of head and Sum *)
  Lemma vsumS_head : forall {n} (v : @vec A (S n)),
      vsum a = a.[(nat2finS 0) + vsum (fun i => a.[(fin2SuccRangeSucc i)).
  Proof. intros. apply fseqsumS_head; auto. Qed.

  (** (∀ i, a.i = b.i + c.i) -> Σa = Σb + Σc *)
  Lemma vsum_add : forall {n} (v1 v2 c : @vec A n),
      (forall i, a.[i = b.[i + c.[i) -> vsum a = vsum b + vsum c.
  Proof. intros. unfold vsum. apply fseqsum_add. auto. Qed.
  
  (** `vsum` which only one item is nonzero, then got this item. *)
  Lemma vsum_unique : forall {n} (v : @vec A n) (x : A) i,
      a.[i = x -> (forall j, i <> j -> a.[j = Azero) -> vsum a = x.
  Proof. intros. apply fseqsum_unique with (i:=i); auto. Qed.

  (** `vsum` of the m+n elements equal to plus of two parts.
      (i < m -> a.i = b.i) ->
      (i < n -> a.(m+i) = c.i) ->
      Σ[0,(m+n)] a = Σ[0,m] b + Σ[m,m+n] c. *)
  Lemma vsum_plusIdx : forall m n (v : @vec A (m + n)) (b : @vec A m) (c : @vec A n),
      (forall i : fin m, a.[(fin2AddRangeR i) = b.[i) ->
      (forall i : nat, a.[(fin2AddRangeAddL i) = c.[i) ->
      vsum a = vsum b + vsum c.
  Proof. intros. apply fseqsum_plusIdx; auto. Qed.

  (** The order of two nested summations can be exchanged.
      ∑[i,0,r](∑[j,0,c] a.ij) = 
      a00 + a01 + ... + a0c + 
      a10 + a11 + ... + a1c + 
      ...
      ar0 + ar1 + ... + arc = 
      ∑[j,0,c](∑[i,0,r] a.ij) *)
  Lemma vsum_vsum_exchg : forall r c (v : @vec (@vec A c) r),
      vsum (fun i => vsum (fun j => a.[i.[j)) =
        vsum (fun j => vsum (fun i => a.[i.[j)).
  Proof. intros. apply fseqsum_fseqsum_exchg. Qed.

  (* ∑ (a@b) = ∑a + ∑b *)
  Lemma vsum_vapp : forall {m n} (v : @vec A m) (b : @vec A n),
      vsum (vapp v1 v2) = vsum a + vsum b.
  Proof.
    intros. apply vsum_plusIdx; intros.
    - erewrite nth_vapp_L. f_equal. rewrite fin2AddRangeR'_fin2AddRangeR. auto.
    - erewrite nth_vapp_R. f_equal.
      rewrite fin2AddRangeAddL'_fin2AddRangeAddL. auto.
      Unshelve. rewrite fin2nat_fin2AddRangeR. apply fin2nat_lt.
      rewrite fin2nat_fin2AddRangeAddL. lia.
  Qed.
  
  (* If equip a `Group` *)
  Section Group.
    Context `{HGroup:Group A Aadd Azero Aopp}.
    Notation "- a" := (Aopp a) : A_scope.
    
    (** (∀ i, a.i = - b.i) -> Σa = - Σb *)
    Lemma vsum_opp : forall {n} (v1 v2 : @vec A n),
        (forall i, a.[i = - b.[i) -> vsum a = - vsum b.
    Proof. intros. unfold vsum. apply fseqsum_opp; auto. Qed.
  End Group.

  (* If equip a `ARing` *)
  Section ARing.
    Context `{HARing:ARing A Aadd Azero Aopp Amul Aone}.
    Infix "*" := (Amul) : A_scope.

    (** (∀ i, a.i = x * b.i) -> Σa = x * Σb *)
    Lemma vsum_cmul : forall {n} (v1 v2 : @vec A n) x,
        (forall i, a.[i = x * b.[i) -> vsum a = x * vsum b.
    Proof. intros. unfold vsum. apply fseqsum_cmul. auto. Qed.
  End ARing.

  (* if equip a `OrderedARing` *)
  Section OrderedARing.
    Context `{HOrderedARing
        : OrderedARing A Aadd Azero Aopp Amul Aone Alt Ale Altb Aleb}.
    (* Check HOrderedARing : Order Alt Ale Altb Aleb. *)
    Infix "*" := (Amul) : A_scope.
    Infix "<" := Alt.
    Infix "<=" := Ale.

    (** (∀ i, 0 <= a.i) -> a.i <= ∑a *)
    Lemma vsum_ge_any : forall {n} (v : @vec A n) i,
        (forall i, Azero <= a.[i) -> a.[i <= vsum a.
    Proof.
      intros. unfold vsum, fseqsum.
      replace (a i) with (ff2f (Azero:=Azero) a (fin2nat i)).
      - apply seqsum_ge_any.
        + intros. specialize (H (nat2fin i0 H0)).
          rewrite nth_ff2f with (E:=H0). auto.
        + apply fin2nat_lt.
      - rewrite nth_ff2f with (E:=fin2nat_lt _). rewrite nat2fin_fin2nat. auto.
    Qed.

    (** (∀ i, 0 <= a.i) -> 0 <= ∑a *)
    Lemma vsum_ge0 : forall {n} (v : @vec A n), (forall i, Azero <= a.[i) -> Azero <= vsum a.
    Proof.
      intros. pose proof (vsum_ge_any a). destruct n.
      - cbv. apply le_refl.
      - apply le_trans with (a.1); auto.
    Qed.
    
    (** (∀ i, 0 <= a.i) -> (∃ i, a.i <> 0) -> 0 < ∑a *)
    Lemma vsum_gt0 : forall {n} (v : @vec A n),
        (forall i, Azero <= a.[i) -> (exists i, a.[i <> Azero) -> Azero < vsum a.
    Proof.
      intros. destruct H0 as [i H0].
      pose proof (vsum_ge0 a H). pose proof (vsum_ge_any a i H).
      assert (Azero < a$i). apply lt_if_le_and_neq; auto.
      apply lt_trans_lt_le with (a$i); auto.
    Qed.
    
    (** (∀i, a.i >= 0) -> ∑a = 0 -> (∀i, a.i = 0) *)
    Lemma vsum_eq0_rev : forall {n} (v : @vec A n),
        (forall i, 0 <= a.[i) -> vsum a = 0 -> (forall i, a.[i = 0).
    Proof.
      intros. destruct (Aeqdec (a$i) 0); auto. exfalso.
      pose proof (vsum_ge_any a i H). rewrite H0 in H1.
      specialize (H i).
      pose proof (@le_antisym _ _ _ _ _ HOrderedARing (a i) 0 H1 H). easy.
    Qed.
    
  End OrderedARing.
                                                                                                                                                                                                                                                                                                                                         *)
                                                                                                                                                                                                                                                                                                                                        End vsum.

                                                                                                                                                                                                                                                                                                                                        Arguments vsum {A} Aadd Azero {n}.

                                                                                                                                                                                                                                                                                                                                        (*

(** vsum with vinsert and vremove  *)
Section vsum_vinsert_vremove.
  Context `{HAGroup : AGroup}.
  Infix "+" := Aadd : A_scope.
  Notation "0" := Azero : A_scope.
  Notation "- a" := (Aopp a) : A_scope.
  Notation Asub v1 v2 := (a + - b).
  Infix "-" := Asub : A_scope.
  Notation vsum := (@vsum _ Aadd Azero).
  Notation seqsum := (@seqsum _ Aadd Azero).
  Notation seqsum_plusIdx := (@seqsum_plusIdx _ Aadd Azero).

  (** ∑(insert a i x) = ∑a + x *)
  Lemma vsum_vinsert : forall {n} (v : @vec A n) (x : A) (i : nat),
      vsum (vinsert a i x) = vsum a + x.
  Proof.
    intros. pose proof (fin2nat_lt i).
    rewrite (vinsert_eq_vinsert' _ (Azero:=Azero)).
    unfold vinsert'. unfold vsum, fseqsum.
    match goal with | |- seqsum ?f _ = _ => remember f as g end.
    replace n with (fin2nat i + (n - fin2nat i)) at 3 by lia.
    replace (S n) with (fin2nat i + (S (n - fin2nat i))) at 1 by lia.
    rewrite seqsum_plusIdx. rewrite seqsum_plusIdx. rewrite associative. f_equal.
    - rewrite Heqg. apply seqsum_eq. intros. unfold f2v,v2f,f2ff,ff2f. simpl in *.
      idx.
    - rewrite seqsumS_head. monoid. rewrite commutative. f_equal.
      + apply seqsum_eq. intros j H0. rewrite Heqg.
        assert (fin2nat i + S j < S n) by lia. rewrite nth_ff2f with (E:=H1).
        assert (fin2nat i + j < n) by lia. rewrite nth_ff2f with (E:=H2).
        rewrite nth_f2v. simpl. idx.
        erewrite nth_v2f. f_equal. idx.
      + rewrite Heqg. rewrite nth_ff2f with (E:=H). rewrite nth_f2v. simpl.
        idx.
        Unshelve. lia.
  Qed.

  (** ∑(remove a i) = ∑a - a.i *)
  Lemma vsum_vremove : forall {n} (v : @vec A (S n)) (i : nat),
      vsum (vremove a i) = vsum a - a$i.
  Proof.
    intros. pose proof (fin2nat_lt i).
    rewrite (vremove_eq_vremove' (Azero:=Azero)).
    unfold vremove'. unfold vsum, fseqsum.
    match goal with | |- seqsum ?f _ = _ => remember f as g end.
    replace n with (fin2nat i + (n - fin2nat i)) at 1 by lia.
    replace (S n) with (fin2nat i + (S (n - fin2nat i))) at 4 by lia.
    rewrite seqsum_plusIdx. rewrite seqsum_plusIdx. rewrite associative. f_equal.
    - rewrite Heqg. apply seqsum_eq; intros.
      unfold f2v,v2f,f2ff,ff2f. simpl in *. idx.
    - rewrite seqsumS_head. monoid.
      symmetry. rewrite commutative. rewrite associative.
      replace (- a i + a!fin2nat i) with 0.
      + monoid. apply seqsum_eq; intros j H0. rewrite Heqg.
        assert (fin2nat i + S j < S n) by lia. rewrite nth_ff2f with (E:=H1).
        assert (fin2nat i + j < n) by lia. rewrite nth_ff2f with (E:=H2).
        rewrite nth_f2v. simpl. idx. erewrite nth_v2f. f_equal. idx.
      + rewrite nth_ff2f with (E:=H). rewrite nat2fin_fin2nat. group.
        Unshelve. lia.
  Qed.
  
End vsum_vinsert_vremove.

(** Extension for `vsum` *)
Section vsum_ext.
  
  Context `{HAMonoidA : AMonoid}.
  Context `{HAMonoidB : AMonoid B Badd Bzero}.
  Context (cmul : A -> B -> B).
  Infix "*" := cmul.
  
  (** ∑(x*ai) = x * a1 + ... + x * ai = x * (a1 + ... + ai) = x * ∑(ai) *)
  Section form1.
    Context (cmul_zero_keep : forall x : A, cmul x Bzero = Bzero).
    Context (cmul_badd : forall (x : A) (y1 y2 : B),
                x * (Badd y1 y2) = Badd (x * y1) (x * y2)).
    
    Lemma vsum_cmul_extX : forall {n} (x : A) (v : @vec B n) (b : @vec B n),
        (forall i, a$i = x * b$i) ->
        @vsum _ Badd Bzero _ a = x * (@vsum _ Badd Bzero _ b).
    Proof. intros. apply fseqsum_cmul_extK; auto. Qed.
  End form1.
  
  (** ∑(ai*x) = a1 * x + ... + ai * x = (a1 + ... + ai) * b = ∑(ai) * x *)
  Section form2.
    Context (cmul_zero_keep : forall x : B, cmul Azero x = Bzero).
    Context (cmul_aadd : forall (x1 x2 : A) (y : B),
                (Aadd x1 x2) * y = Badd (x1 * y) (x2 * y)).
    Lemma vsum_cmul_extV : forall {n} (x : B) (v : @vec B n) (b : @vec A n),
        (forall i, a$i = b$i * x) ->
        @vsum _ Badd Bzero _ a = (@vsum _ Aadd Azero _ b) * x.
    Proof. intros. apply fseqsum_cmul_extA; auto. Qed.
  End form2.
  
End vsum_ext.

                                                                                                                                                                                                                                                                                                                                         *)

                                                                                                                                                                                                                                                                                                                                        (* ======================================================================= *)
                                                                                                                                                                                                                                                                                                                                        (** ** Vector addition *)
                                                                                                                                                                                                                                                                                                                                        Section vadd.
                                                                                                                                                                                                                                                                                                                                          Context `{AMonoid}.
                                                                                                                                                                                                                                                                                                                                          Infix "+" := Aadd : A_scope.
                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                          Notation vec := (@vec A).
                                                                                                                                                                                                                                                                                                                                          Notation vzero := (vzero Azero).

                                                                                                                                                                                                                                                                                                                                          Definition vadd {n} (v1 v2 : vec n) : vec n := vmap2 Aadd v1 v2.
                                                                                                                                                                                                                                                                                                                                          Infix "+" := vadd : vec_scope.

                                                                                                                                                                                                                                                                                                                                        End vadd.

                                                                                                                                                                                                                                                                                                                                        Compute @vrepeat _ 3 0. 0. 3 0.
                                                                                                                                                                                                                                                                                                                                        Require Import Reals.
                                                                                                                                                                                                                                                                                                                                        Definition vaddR := (@vadd _ Rplus).
                                                                                                                                                                                                                                                                                                                                        Definition vsumR := (@vsum _ Rplus R0).
                                                                                                                                                                                                                                                                                                                                        Extraction "PVector.ml" vaddR vsumR vrepeat.? vget vset vconst vmake.

                                                                                                                                                                                                                                                                                                                                        ?
                                                                                                                                                                                                                                                                                                                                          (** (a + b) + c = a + (b + c) *)
                                                                                                                                                                                                                                                                                                                                          Lemma vadd_assoc : forall {n} (v1 v2 c : vec n), (a + b) + c = a + (b + c).
                                                                                                                                                                                                                                                                                                                                        Proof. intros. apply vmap2_assoc. Qed.

                                                                                                                                                                                                                                                                                                                                        (** a + b = b + a *)
                                                                                                                                                                                                                                                                                                                                        Lemma vadd_comm : forall {n} (v1 v2 : vec n), a + b = b + a.
                                                                                                                                                                                                                                                                                                                                        Proof. intros. apply vmap2_comm. Qed.

                                                                                                                                                                                                                                                                                                                                        (** 0 + a = a *)
                                                                                                                                                                                                                                                                                                                                        Lemma vadd_0_l : forall {n} (v : vec n), vzero + a = a.
                                                                                                                                                                                                                                                                                                                                        Proof.
                                                                                                                                                                                                                                                                                                                                          intros. apply veq_iff; intros. unfold vadd. rewrite nth_vmap2. group.
                                                                                                                                                                                                                                                                                                                                        Qed.

                                                                                                                                                                                                                                                                                                                                        (** a + 0 = a *)
                                                                                                                                                                                                                                                                                                                                        Lemma vadd_0_r : forall {n} (v : vec n), a + vzero = a.
                                                                                                                                                                                                                                                                                                                                        Proof. intros. rewrite vadd_comm. apply vadd_0_l. Qed.

                                                                                                                                                                                                                                                                                                                                        (** <vadd,vzero> is an abelian monoid *)
                                                                                                                                                                                                                                                                                                                                        #[export] Instance vadd_AMonoid : forall n, AMonoid (@vadd n) vzero.
                                                                                                                                                                                                                                                                                                                                        Proof.
                                                                                                                                                                                                                                                                                                                                          intros. repeat constructor; intros;
                                                                                                                                                                                                                                                                                                                                            try apply vadd_assoc;
                                                                                                                                                                                                                                                                                                                                            try apply vadd_comm;
                                                                                                                                                                                                                                                                                                                                            try apply vadd_0_l;
                                                                                                                                                                                                                                                                                                                                            try apply vadd_0_r.
                                                                                                                                                                                                                                                                                                                                        Qed.

                                                                                                                                                                                                                                                                                                                                        (** (a + b).i = a.i + b.i *)
                                                                                                                                                                                                                                                                                                                                        Lemma nth_vadd : forall {n} (v1 v2 : vec n) i, (a + b).[i = (a.[i + b.[i)%A.
                                                                                                                                                                                                                                                                                                                                                                                                        Proof. intros. unfold vadd. rewrite nth_vmap2. auto. Qed.
                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                        (** (a + b) + c = (a + c) + b *)
                                                                                                                                                                                                                                                                                                                                                                                                        Lemma vadd_perm : forall {n} (v1 v2 c : vec n), (a + b) + c = (a + c) + b.
                                                                                                                                                                                                                                                                                                                                                                                                        Proof. intros. rewrite !associative. f_equal. apply commutative. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                        End vadd.

                                                                                                                                                                                                                                                                                                                                                                                                        Section vadd_extra.
                                                                                                                                                                                                                                                                                                                                                                                                          Context `{AMonoid}.

                                                                                                                                                                                                                                                                                                                                                                                                          (* 所有向量相加后取第j个分量 = 取出向量的第j个分量后再相加 *)
                                                                                                                                                                                                                                                                                                                                                                                                          (** (∑a).j = ∑(a.j), which a is a vector of vector *)
                                                                                                                                                                                                                                                                                                                                                                                                          Lemma nth_vsum : forall {r c} (v : @vec (@vec A c) r) j,
                                                                                                                                                                                                                                                                                                                                                                                                              (@vsum _ (@vadd _ Aadd _) (vzero Azero) _ a).[j =
                                                                                                                                                                                                                                                                                                                                                                                                                                                              @vsum _ Aadd Azero _ (fun i => a.[i.[j).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  intros. unfold vsum. induction r. cbv. auto. unfold vec in *.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  rewrite fseqsumS_tail with (g:=fun i => a (fin2SuccRange i)); auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  rewrite nth_vadd. rewrite IHr.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  rewrite fseqsumS_tail with (g:=fun i => a (fin2SuccRange i) j); auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                End vadd_extra.


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                (** ** Vector opposition *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                Section vopp.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  (* Let's have an Abelian-Group *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  Context `{AGroup A Aadd Azero}.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  Notation "- a" := (Aopp a) : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  Notation vzero := (vzero Azero).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  Notation vadd := (@vadd _ Aadd).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  Infix "+" := vadd : vec_scope.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  Definition vopp {n} (v : vec n) : vec n := vmap Aopp a.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  Notation "- a" := (vopp a) : vec_scope.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  (** (- a).i = - (a.i) *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  Lemma nth_vopp : forall {n} (v : vec n) i, (- a).[i = (- (a.[i))%A.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         Proof. intros. cbv. auto. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         (** - a + a = 0 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         Lemma vadd_vopp_l : forall {n} (v : vec n), (- a) + a = vzero.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         Proof. intros. apply veq_iff; intros. cbv. group. Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         (** a + - a = 0 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         Lemma vadd_vopp_r : forall {n} (v : vec n), a + (- a) = vzero.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         Proof. intros. apply veq_iff; intros. cbv. group. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         (** <vadd,vzero,vopp> is an abelian group *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         #[export] Instance vadd_AGroup : forall n, @AGroup (vec n) vadd vzero vopp.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           intros. repeat constructor; intros;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             try apply vadd_AMonoid;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             try apply vadd_vopp_l;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             try apply vadd_vopp_r.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         (* Now, we ca use group theory on this instance *)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         (** - (- a) = a *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         Lemma vopp_vopp : forall {n} (v : vec n), - (- a) = a.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         Proof. intros. apply group_opp_opp. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         (** a = - b <-> - v1 == v2 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         Lemma vopp_exchange : forall {n} (v1 v2 : vec n), a = - b <-> - v1 == v2.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         Proof. intros. split; intros; subst; rewrite vopp_vopp; auto. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         (** - (vzero) = vzero *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         Lemma vopp_vzero : forall {n:nat}, - (@Vector.vzero _ Azero n) = vzero.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         Proof. intros. apply group_opp_0. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         (** - a = vzero <-> a = vzero *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         Lemma vopp_eq0_iff : forall {n} (v : vec n), - a = vzero <-> a = vzero.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           intros. split; intros; rewrite veq_iff in *; intros;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             specialize (H0 i); rewrite nth_vzero, nth_vopp in *.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           - apply group_opp_eq0_iff; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           - apply group_opp_eq0_iff; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         (** - (a + b) = (- a) + (- b) *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         Lemma vopp_vadd : forall {n} (v1 v2 : vec n), - (a + b) = (- a) + (- b).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         Proof. intros. rewrite group_opp_distr. apply commutative. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         End vopp.


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         (** ** Vector subtraction *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         Section vsub.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           (* Let's have an Abelian-Group *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Context `{AGroup A Aadd Azero}.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Infix "+" := Aadd : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Notation "- a" := (Aopp a) : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Notation Asub v1 v2 := (a + (- b))%A.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Infix "-" := Asub : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Notation vzero := (vzero Azero).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Notation vadd := (@vadd _ Aadd).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Notation vopp := (@vopp _ Aopp).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Infix "+" := vadd : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Notation "- a" := (vopp a) : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Definition vsub {n} (v1 v2 : vec n) : vec n := a + (- b).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Infix "-" := vsub : vec_scope.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           (** (a - b).i = a.i - b.i *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Lemma nth_vsub : forall {n} (v1 v2 : vec n) i, (a - b).[i = (a.[i - b.[i)%A.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Proof. intros. cbv. auto. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           (** a - b = - (b - a) *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Lemma vsub_comm : forall {n} (v1 v2 : vec n), a - b = - (b - a).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             intros. unfold vsub. rewrite group_opp_distr. rewrite group_opp_opp. auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           (** (a - b) - c = a - (b + c) *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Lemma vsub_assoc : forall {n} (v1 v2 c : vec n), (a - b) - c = a - (b + c).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             intros. unfold vsub. rewrite associative.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             f_equal. rewrite group_opp_distr. apply commutative.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           (** (a + b) - c = a + (b - c) *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Lemma vsub_assoc1 : forall {n} (v1 v2 c : vec n), (a + b) - c = a + (b - c).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Proof. intros. unfold vsub. group. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           (** (a - b) - c = (a - c) - b *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Lemma vsub_assoc2 : forall {n} (v1 v2 c : vec n), (a - b) - c = (a - c) - b.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Proof. intros. unfold vsub. group. f_equal. apply commutative. Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           (** 0 - a = - a *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Lemma vsub_0_l : forall {n} (v : vec n), vzero - a = - a.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Proof. intros. unfold vsub. group. Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           (** a - 0 = a *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Lemma vsub_0_r : forall {n} (v : vec n), a - vzero = a.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Proof. intros. unfold vsub. rewrite vopp_vzero. group. Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           (** a - a = 0 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Lemma vsub_self : forall {n} (v : vec n), a - a = vzero.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Proof. intros. unfold vsub. group. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           (** a - b = 0 <-> v1 == v2 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Lemma vsub_eq0_iff_eq : forall {n} (v1 v2 : vec n), a - b = vzero <-> v1 == v2.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Proof. intros. apply group_sub_eq0_iff_eq. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           End vsub.


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           (** ** Vector scalar multiplication *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Section vcmul.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             (* Let's have an Abelian-ring *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             Context `{HARing : ARing A Aadd Azero Aopp Amul Aone}.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             Add Ring ring_inst : (make_ring_theory HARing).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             Infix "+" := Aadd : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             Infix "*" := Amul : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             Notation "- a" := (Aopp a) : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             Notation Asub v1 v2 := (a + (- b))%A.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             Infix "-" := Asub : A_scope.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             Notation vzero := (vzero Azero).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             Notation vadd := (@vadd _ Aadd).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             Notation vopp := (@vopp _ Aopp).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             Notation vsub := (@vsub _ Aadd Aopp).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             Infix "+" := vadd : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             Notation "- a" := (vopp a) : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             Infix "-" := vsub : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             Definition vcmul {n : nat} (x : A) (v : vec n) : vec n := vmap (fun y => Amul x y) a.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             Infix "\.*" := vcmul : vec_scope.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             (** (x .* a).i = x * a.i *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             Lemma nth_vcmul : forall {n} (v : vec n) x i, (x \.* a).[i = x * (a.[i).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Proof. intros. cbv. auto. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (** x .* (y .* a) = (x * y) .* a *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Lemma vcmul_assoc : forall {n} (v : vec n) x y,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   x \.* (y \.* a) = (x * y)%A \.* a.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Proof. intros. apply veq_iff; intros. cbv. ring. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (** x .* (y .* a) = y .* (x .* a) *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Lemma vcmul_perm : forall {n} (v : vec n) x y,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   x \.* (y \.* a) = y \.* (x \.* a).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Proof. intros. rewrite !vcmul_assoc. f_equal. ring. Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (** (x + y) .* a = (x .* a) + (y .* a) *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Lemma vcmul_add : forall {n} x y (v : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (x + y)%A \.* a = (x \.* a) + (y \.* a).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Proof. intros. apply veq_iff; intros. cbv. ring. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (** x .* (a + b) = (x .* a) + (x .* b) *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Lemma vcmul_vadd : forall {n} x (v1 v2 : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   x \.* (a + b) = (x \.* a) + (x \.* b).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Proof. intros. apply veq_iff; intros. cbv. ring. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (** 0 .* a = vzero *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Lemma vcmul_0_l : forall {n} (v : vec n), Azero \.* a = vzero.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Proof. intros. apply veq_iff; intros. cbv. ring. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (** a .* vzero = vzero *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Lemma vcmul_0_r : forall {n} a, a \.* vzero = (@Vector.vzero _ Azero n).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Proof. intros. apply veq_iff; intros. cbv. ring. Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (** 1 .* a = a *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Lemma vcmul_1_l : forall {n} (v : vec n), Aone \.* a = a.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Proof. intros. apply veq_iff; intros. cbv. ring. Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (** - 1 .* a = - a *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Lemma vcmul_neg1_l : forall {n} (v : vec n), (- Aone)%A \.* a = - a.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Proof. intros. apply veq_iff; intros. cbv. ring. Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (** (- x) .* a = - (x .* a) *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Lemma vcmul_opp : forall {n} x (v : vec n), (- x)%A \.* a = - (x \.* a).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Proof. intros. apply veq_iff; intros. cbv. ring. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (* Tips: this proof shows a proof by computation, due to the Fin-Function 
     model. *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (** x .* (- a) = - (x .* a) *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Lemma vcmul_vopp : forall {n} x (v : vec n), x \.* (- a) = - (x \.* a).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Proof. intros. apply veq_iff; intros. cbv. ring. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (* Tips: this proof shows a proof by derivation *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (** (- x) .* (- a) = x .* a *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Lemma vcmul_opp_vopp : forall {n} x (v : vec n), (- x)%A \.* (- a) = x \.* a.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Proof. intros. rewrite vcmul_vopp, vcmul_opp. rewrite vopp_vopp. auto. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (** x .* (a - b) = (x .* a) - (x .* b) *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Lemma vcmul_vsub : forall {n} x (v1 v2 : vec n), x \.* (a - b) = (x \.* a) - (x \.* b).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Proof. intros. unfold vsub. rewrite vcmul_vadd. rewrite vcmul_vopp. auto. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (** <vadd,vzero,vopp> is an abelian group *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               #[export] Instance vec_AGroup : forall n, @AGroup (vec n) vadd vzero vopp.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 intros. repeat constructor; intros;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   try apply vadd_AMonoid;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   try apply vadd_vopp_l;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   try apply vadd_vopp_r.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (* If equip a `Dec` *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Section AeqDec.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Context {AeqDec : Dec (@eq A)}.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** a <> 0 -> b <> 0 -> x .* v1 == v2 -> x <> 0 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Lemma vcmul_eq_imply_x_neq0 : forall {n} x (v1 v2 : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     a <> vzero -> b <> vzero -> x \.* v1 == v2 -> x <> Azero.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   intros. destruct (Aeqdec x Azero); auto. exfalso. subst.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   rewrite vcmul_0_l in H0. easy.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               End AeqDec.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (* If equip a `Dec` and a `Field` *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Section Dec_Field.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Context {AeqDec : Dec (@eq A)}.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Context `{HField : Field A Aadd Azero Aopp Amul Aone Ainv}.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** x .* a = 0 -> (x = 0) \/ (a = 0) *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Lemma vcmul_eq0_imply_x0_or_v0 : forall {n} x (v : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     x \.* a = vzero -> (x = Azero) \/ (a = vzero).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   intros. destruct (Aeqdec x Azero); auto. right.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   apply veq_iff; intros. rewrite veq_iff in H. specialize (H i).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   cbv in H. cbv. apply field_mul_eq0_iff in H; auto. tauto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** x .* a = 0 -> a <> 0 -> x = 0 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Corollary vcmul_eq0_imply_x0 : forall {n} x (v : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     x \.* a = vzero -> a <> vzero -> x = Azero.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof. intros. apply (vcmul_eq0_imply_x0_or_v0 x a) in H; tauto. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** x .* a = 0 -> x <> 0 -> a = 0 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Corollary vcmul_eq0_imply_v0 : forall {n} x (v : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     x \.* a = vzero -> x <> Azero -> a = vzero.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof. intros. apply (vcmul_eq0_imply_x0_or_v0 x a) in H; tauto. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** x <> 0 -> a <> 0 -> x \.* a <> 0 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Corollary vcmul_neq0_neq0_neq0 : forall {n} x (v : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     x <> Azero -> a <> vzero -> x \.* a <> vzero.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof. intros. intro. apply vcmul_eq0_imply_x0_or_v0 in H1; tauto. Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** x .* a = a -> x = 1 \/ a = 0 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Lemma vcmul_same_imply_x1_or_v0 : forall {n} x (v : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     x \.* a = a -> (x = Aone) \/ (a = vzero).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   intros. destruct (Aeqdec x Aone); auto. right.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   apply veq_iff; intros. rewrite veq_iff in H. specialize (H i).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   cbv in H. cbv. apply field_mul_eq_imply_a1_or_b0 in H; auto. tauto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** x = 1 \/ a = 0 -> x .* a = a *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Lemma vcmul_same_if_x1_or_v0 : forall {n} x (v : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     (x = Aone \/ a = vzero) -> x \.* a = a.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   intros. destruct H; subst. apply vcmul_1_l; auto. apply vcmul_0_r; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** x .* a = a -> a <> 0 -> x = 1 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Corollary vcmul_same_imply_x1 : forall {n} x (v : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     x \.* a = a -> a <> vzero -> x = Aone.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof. intros. apply (vcmul_same_imply_x1_or_v0 x a) in H; tauto. Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** x .* a = a -> x <> 1 -> a = 0 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Corollary vcmul_same_imply_v0 : forall {n} x (v : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     x \.* a = a -> x <> Aone -> a = vzero.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof. intros. apply (vcmul_same_imply_x1_or_v0 x a) in H; tauto. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** x .* a = y .* a -> (x = y \/ a = 0) *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Lemma vcmul_sameV_imply_eqX_or_v0 : forall {n} x y (v : vec n), 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     x \.* a = y \.* a -> (x = y \/ a = vzero).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   intros. destruct (Aeqdec x y); auto. right. rewrite veq_iff in H.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   rewrite veq_iff. intros. specialize (H i). rewrite !nth_vcmul in H.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   destruct (Aeqdec (a i) Azero); auto. apply field_mul_cancel_r in H; tauto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** x .* a = y * a -> a <> 0 -> x = y *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Corollary vcmul_sameV_imply_eqX : forall {n} x y (v : vec n), 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     x \.* a = y \.* a -> a <> vzero -> x = y.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof. intros. apply vcmul_sameV_imply_eqX_or_v0 in H; tauto. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** x .* a  = y .* a -> x <> y -> a = 0 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Corollary vcmul_sameV_imply_v0 : forall {n} x y (v : vec n), 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     x \.* a = y \.* a -> x <> y -> a = vzero.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof. intros. apply vcmul_sameV_imply_eqX_or_v0 in H; tauto. Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               End Dec_Field.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               End vcmul.


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (** ** Dot product *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Section vdot.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (* Let's have an Abelian-ring *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Context `{HARing : ARing A Aadd Azero Aopp Amul Aone}.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Add Ring ring_inst : (make_ring_theory HARing).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "+" := Aadd : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation "0" := Azero.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation "- a" := (Aopp a) : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation Asub v1 v2 := (a + (- b))%A.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "-" := Asub : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "*" := Amul : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation "1" := Aone.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation "a ²" := (a * a) : A_scope.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vzero := (vzero Azero).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vadd := (@vadd _ Aadd).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vopp := (@vopp _ Aopp).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vsub := (@vsub _ Aadd Aopp).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vcmul := (@vcmul _ Amul).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation seqsum := (@seqsum _ Aadd Azero).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vsum := (@vsum _ Aadd Azero).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "+" := vadd : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation "- a" := (vopp a) : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "-" := vsub : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "\.*" := vcmul : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Definition vdot {n : nat} (v1 v2 : vec n) : A := vsum (vmap2 Amul v1 v2).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation "< a , b >" := (vdot v1 v2) : vec_scope.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** <a, b> = <b, a> *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Lemma vdot_comm : forall {n} (v1 v2 : vec n), <a, b> = <b, a>.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof. intros. apply vsum_eq; intros. rewrite vmap2_comm; auto. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** <vzero, a> = vzero *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Lemma vdot_0_l : forall {n} (v : vec n), <vzero, a> = Azero.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   intros. unfold vdot,vsum. apply fseqsum_eq0; intros.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   rewrite nth_vmap2, nth_vzero. ring.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** <a, vzero> = vzero *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Lemma vdot_0_r : forall {n} (v : vec n), <a, vzero> = Azero.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof. intros. rewrite vdot_comm, vdot_0_l; auto. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** <a + b, c> = <a, c> + <b, c> *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Lemma vdot_vadd_l : forall {n} (v1 v2 c : vec n), <a + b, c> = (<a, c> + <b, c>)%A.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof. intros. unfold vdot. apply vsum_add; intros. cbv. ring. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** <a, b + c> = <a, b> + <a, c> *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Lemma vdot_vadd_r : forall {n} (v1 v2 c : vec n), <a, b + c> = (<a, b> + <a, c>)%A.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   intros. rewrite vdot_comm. rewrite vdot_vadd_l. f_equal; apply vdot_comm.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** <- a, b> = - <a, b> *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Lemma vdot_vopp_l : forall {n} (v1 v2 : vec n), < - a, b> = (- <a, b>)%A.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof. intros. unfold vdot. apply vsum_opp; intros. cbv. ring. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** <a, - b> = - <a, b> *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Lemma vdot_vopp_r : forall {n} (v1 v2 : vec n), <a, - b> = (- <a, b>)%A.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof. intros. rewrite vdot_comm, vdot_vopp_l, vdot_comm. auto. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** <a - b, c> = <a, c> - <b, c> *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Lemma vdot_vsub_l : forall {n} (v1 v2 c : vec n), <a - b, c> = (<a, c> - <b, c>)%A.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof. intros. unfold vsub. rewrite vdot_vadd_l. f_equal. apply vdot_vopp_l. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** <a, b - c> = <a, b> - <a, c> *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Lemma vdot_vsub_r : forall {n} (v1 v2 c : vec n), <a, b - c> = (<a, b> - <a, c>)%A.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof. intros. unfold vsub. rewrite vdot_vadd_r. f_equal. apply vdot_vopp_r. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** <x .* a, b> = x .* <a, b> *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Lemma vdot_vcmul_l : forall {n} (v1 v2 : vec n) x, <x \.* a, b> = x * <a, b>.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof. intros. unfold vdot. apply vsum_cmul; intros. cbv. ring. Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** <a, x .* b> = x .* <a, b> *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Lemma vdot_vcmul_r : forall {n} (v1 v2 : vec n) x, <a, x \.* b> = x * <a, b>.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   intros. rewrite vdot_comm. rewrite vdot_vcmul_l. f_equal; apply vdot_comm.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** <a, veye i> = a i *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Lemma vdot_veye_r : forall {n} (v : vec n) i, <a, veye 0 1 i> = a i.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   intros. apply vsum_unique with (i:=i).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   - rewrite nth_vmap2. rewrite nth_veye_eq. rewrite identityRight; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   - intros. rewrite nth_vmap2. rewrite nth_veye_neq; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     rewrite ring_mul_0_r; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** <veye i, a> = a i *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Lemma vdot_veye_l : forall {n} (v : vec n) i, <veye 0 1 i, a> = a i.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof. intros. rewrite vdot_comm. apply vdot_veye_r. Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (* If (@eq A) is decidable *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Section AeqDec.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Context {AeqDec : Dec (@eq A)}.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** <a, b> <> 0 -> a <> 0 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vdot_neq0_imply_neq0_l : forall {n} (v1 v2 : vec n), <a, b> <> 0 -> a <> vzero.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. destruct (Aeqdec a vzero); auto. subst. rewrite vdot_0_l in H. easy.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** <a, b> <> 0 -> b <> 0 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vdot_neq0_imply_neq0_r : forall {n} (v1 v2 : vec n), <a, b> <> 0 -> b <> vzero.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. destruct (Aeqdec b vzero); auto. subst. rewrite vdot_0_r in H. easy.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** (∀ c, <a, c> = <b, c>) -> v1 == v2 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vdot_cancel_r : forall {n} (v1 v2 : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       (forall c : vec n, <a, c> = <b, c>) -> v1 == v2.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. destruct (Aeqdec v1 v2) as [H1|H1]; auto. exfalso.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     apply vneq_iff_exist_nth_neq in H1. destruct H1 as [i H1].
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     specialize (H (veye 0 1 i)). rewrite !vdot_veye_r in H. easy.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** (∀ c, <c, a> = <c, b>) -> v1 == v2 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vdot_cancel_l : forall {n} (v1 v2 : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       (forall c : vec n, <c, a> = <c, b>) -> v1 == v2.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. apply vdot_cancel_r. intros. rewrite !(vdot_comm _ c). auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 End AeqDec.


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (* If equip an ordered-abelian-ring *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Section OrderedARing.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Context `{HOrderedARing : OrderedARing A Aadd Azero Aopp Amul Aone}.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Infix "<" := Alt.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Infix "<=" := Ale.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** 0 <= <a, a> *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vdot_ge0 : forall {n} (v : vec n), 0 <= (<a, a>).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. unfold vdot, vsum, fseqsum, vmap2, ff2f. apply seqsum_ge0; intros.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     idx. apply sqr_ge0.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** <a, b> ² <= <a, a> * <b, b> *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vdot_sqr_le : forall {n} (v1 v2 : vec n), (<a, b> ²) <= <a, a> * <b, b>.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. unfold vdot,vsum,vmap2. destruct n.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - cbv. apply le_refl.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - (* Convert dependent "vec" to non-dependent "nat -> A", by "Abstraction" *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       remember (fun i => a (nat2finS i)) as f.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       remember (fun i => b (nat2finS i)) as g.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       replace (fseqsum (fun i => (a i * b i)))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         with (seqsum (fun i => f i * g i) (S n)); auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       2:{ rewrite ?Heqf,?Heqg. rewrite !fseqsum_eq_seqsum_succ. auto. }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       replace (fseqsum (fun i => a i * a i))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         with (seqsum (fun i => f i * f i) (S n)).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       2:{ rewrite ?Heqf,?Heqg. rewrite !fseqsum_eq_seqsum_succ. auto. }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       replace (fseqsum (fun i => b i * b i))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         with (seqsum (fun i => g i * g i) (S n)).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       2:{ rewrite ?Heqf,?Heqg. rewrite !fseqsum_eq_seqsum_succ. auto. }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       apply seqsum_SqrMul_le_MulSqr.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** (v i)² <= <a, a> *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma nth_sqr_le_vdot : forall {n} (v : vec n) (i : nat), (a i) ² <= <a, a>.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. unfold vdot.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     pose ((fun i => (a$i) * (a$i)) : vec n) as u.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     replace (a i)² with (u i). replace (vmap2 Amul a a) with u.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     apply vsum_ge_any.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - intros. unfold u. apply sqr_ge0.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - unfold u. auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - unfold u. auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 End OrderedARing.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (* If equip an ordered-field and `Dec` *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Section OrderedField_Dec.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Context {AeqDec : Dec (@eq A)}.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Context `{HOrderedField : OrderedField A Aadd Azero Aopp Amul Aone}.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Notation "/ a" := (Ainv a).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Notation Adiv x y := (x * / y).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Infix "/" := Adiv.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Infix "<" := Alt.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Infix "<=" := Ale.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** a = 0 -> <a, a> = 0 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vdot_same_eq0_if_vzero : forall {n} (v : vec n), a = vzero -> <a, a> = 0.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof. intros. subst. rewrite vdot_0_l; auto. Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** <a, a> = 0 -> a = 0 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vdot_same_eq0_then_vzero : forall {n} (v : vec n), <a, a> = 0 -> a = vzero.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. unfold vdot,vsum,fseqsum in H. apply veq_iff; intros.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     apply seqsum_eq0_imply_seq0 with (i:=fin2nat i) in H.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - rewrite nth_ff2f with (E:=fin2nat_lt _) in H.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       rewrite nat2fin_fin2nat in H. rewrite nth_vmap2 in H.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       apply field_sqr_eq0_reg in H; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - intros. rewrite nth_ff2f with (E:=H0). rewrite nth_vmap2. apply sqr_ge0.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - apply fin2nat_lt.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** a <> vzero -> <a, a> <> 0 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vdot_same_neq0_if_vnonzero : forall {n} (v : vec n), a <> vzero -> <a, a> <> 0.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof. intros. intro. apply vdot_same_eq0_then_vzero in H0; auto. Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** <a, a> <> 0 -> a <> vzero *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vdot_same_neq0_then_vnonzero : forall {n} (v : vec n), <a, a> <> 0 -> a <> vzero.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof. intros. intro. apply vdot_same_eq0_if_vzero in H0; auto. Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** 0 < <a, a> *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vdot_gt0 : forall {n} (v : vec n), a <> vzero -> Azero < (<a, a>).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. apply vdot_same_neq0_if_vnonzero in H. pose proof (vdot_ge0 a).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     apply lt_if_le_and_neq; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** <a, b>² / (<a, a> * <b, b>) <= 1. *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vdot_sqr_le_form2 : forall {n} (v1 v2 : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       a <> vzero -> b <> vzero -> <a, b>² / (<a, a> * <b, b>) <= 1.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     pose proof (vdot_gt0 a H). pose proof (vdot_gt0 b H0).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     pose proof (vdot_sqr_le v1 v2).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     destruct (Aeqdec (<a, b>) 0) as [H4|H4].
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - rewrite H4. ring_simplify. apply le_0_1.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - apply le_imply_div_le_1 in H3; auto. apply sqr_gt0. auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 End OrderedField_Dec.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               End vdot.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Section vdot_extra.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Context `{HARing : ARing}.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Add Ring ring_inst : (make_ring_theory HARing).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vdot := (@vdot _ Aadd Azero Amul).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** <<a,D>, b> = <a, <D,b> *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (* For example:
     (a1,a2,a3) [D11,D12] [b1]  记作 a*D*b，
                [D21,D22] [b2]
                [D31,D32]
     (a*D)*b = <a,col(D,1)> b1 + <a,col(D,2)> b2
             = (a1D11+a2D21+a3D31)b1 + (a1D12+a2D22+a3D32)b2
     a*(D*b) = a1 <row(D,1),b> + a2 <row(D,2),b> + a3 <row(D,3),b>
             = a1(D11b1+D12b2)+a2(D21b1+D22b2)+a3(D31b1+D32b2) *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Theorem vdot_assoc :
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   forall {r c} (v : @vec A c) (D : @vec (@vec A r) c) (b : @vec A r),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     vdot (fun j => vdot a (fun i => D i j)) b = vdot a (fun i => vdot (D i) b).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   intros. unfold vdot. unfold vmap2.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   pose proof (vsum_vsum_exchg c r (fun i j => Amul (Amul (a i) (D i j)) (b j))).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   match goal with
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | H: ?a1 = ?a2 |- ?b1 = ?b2 => replace b1 with a2; [replace b2 with a1|]; auto
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   end.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   - f_equal. extensionality i. apply vsum_cmul; intros. ring.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   - f_equal. extensionality i. rewrite commutative. apply vsum_cmul; intros. ring.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               End vdot_extra.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (* ======================================================================= *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (** ** Euclidean norm (L2 norm), Length of vector *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Section vlen.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (* Euclidean norm == Euclidean length (distance) = L2 norm == L2 distance *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Context `{HARing : ARing A Aadd Azero Aopp Amul Aone}.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Add Ring ring_inst : (make_ring_theory HARing).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Context `{HConvertToR
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     : ConvertToR A Aadd Azero Aopp Amul Aone Ainv Alt Ale Altb Aleb a2r}.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "+" := Aadd : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation "0" := Azero : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "*" := Amul : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (* Notation "a ²" := (a * a) : A_scope. *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation "1" := Aone : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation "| a |" := (@Aabs _ 0 Aopp Aleb a) : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vzero := (@vzero _ Azero).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vadd := (@vadd _ Aadd).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vopp := (@vopp _ Aopp).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vsub := (@vsub _ Aadd Aopp).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vcmul := (@vcmul _ Amul).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vdot := (@vdot _ Aadd Azero Amul).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "+" := vadd : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation "- a" := (vopp a) : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "-" := vsub : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "\.*" := vcmul : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation "< a , b >" := (vdot v1 v2) : vec_scope.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** Length (magnitude) of a vector, is derived by inner-product *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Definition vlen {n} (v : vec n) : R := R_sqrt.sqrt (a2r (<a, a>)).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation "|| a ||" := (vlen a) : vec_scope.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** ||vzero|| = 0 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Lemma vlen_vzero : forall {n:nat}, @vlen n vzero = 0%R.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof. intros. unfold vlen. rewrite vdot_0_l. rewrite a2r_0 at 1. ra. Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Section OrderedARing.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Context `{HOrderedARing
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       : OrderedARing A Aadd Azero Aopp Amul Aone Alt Ale Altb Aleb}.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Infix "<" := Alt : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Infix "<=" := Ale : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** 0 <= ||a|| *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vlen_ge0 : forall {n} (v : vec n), (0 <= ||a||)%R.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof. intros. unfold vlen. ra. Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** ||a|| = ||b|| <-> <a, a> = <b, b> *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vlen_eq_iff_dot_eq : forall {n} (v1 v2 : vec n), ||a|| = ||b|| <-> <a, a> = <b, b>.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. unfold vlen. split; intros H; try rewrite H; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     apply sqrt_inj in H.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     rewrite a2r_eq_iff in H; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     apply a2r_ge0_iff; apply vdot_ge0.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     apply a2r_ge0_iff; apply vdot_ge0.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** <a, a> = ||a||² *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vdot_same : forall {n} (v : vec n), a2r (<a, a>) = (||a||²)%R.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. unfold vlen. rewrite Rsqr_sqrt; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     apply a2r_ge0_iff. apply vdot_ge0.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** |a i| <= ||a|| *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma nth_le_vlen : forall {n} (v : vec n) (i : nat),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       a <> vzero -> (a2r (|a i|%A) <= ||a||)%R.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. apply Rsqr_incr_0_var.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - rewrite <- vdot_same. unfold Rsqr. rewrite <- a2r_mul. apply a2r_le_iff.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       replace (|a i| * |a i|) with (a i * a i). apply nth_sqr_le_vdot.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       rewrite <- Aabs_mul. rewrite Aabs_right; auto. apply sqr_ge0.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - apply vlen_ge0.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** ||a|| = 1 <-> <a, a> = 1 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vlen_eq1_iff_vdot1 : forall {n} (v : vec n), ||a|| = 1%R <-> <a, a> = 1.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. unfold vlen. rewrite sqrt_eq1_iff. rewrite a2r_eq1_iff. easy.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** ||- a|| = ||a|| *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vlen_vopp : forall n (v : vec n), ||- a|| = ||a||.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. unfold vlen. f_equal. f_equal. rewrite vdot_vopp_l,vdot_vopp_r. ring.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** ||x .* a|| = |x| * ||a|| *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vlen_vcmul : forall n x (v : vec n), ||x \.* a|| = ((a2r (|x|))%A * ||a||)%R.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. unfold vlen.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     rewrite commutative.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     replace (a2r (|x|)%A) with (|(a2r x)|)%R.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     2:{ rewrite a2r_Aabs. auto. }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     rewrite <- sqrt_square_abs. rewrite <- sqrt_mult_alt.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - f_equal. rewrite vdot_vcmul_l, vdot_vcmul_r, <- associative.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       rewrite a2r_mul. rewrite commutative. f_equal. rewrite a2r_mul. auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - apply a2r_ge0_iff. apply vdot_ge0.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** ||a + b||² = ||a||² + ||a||² + 2 * <a, b> *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vlen_sqr_vadd : forall {n} (v1 v2 : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ||(a + b)||² = (||a||² + ||b||² + 2 * a2r (<a, b>))%R.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. rewrite <- !vdot_same. rewrite !vdot_vadd_l, !vdot_vadd_r.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     rewrite (vdot_comm b a). rewrite !a2r_add. ring.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** ||a - b||² = ||a||² + ||b||² - 2 * <a, b> *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vlen_sqr_vsub : forall {n} (v1 v2 : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ||(a - b)||² = (||a||² + ||b||² - 2 * a2r (<a, b>))%R.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. rewrite <- !vdot_same. unfold vsub.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     rewrite !vdot_vadd_l, !vdot_vadd_r.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     rewrite !vdot_vopp_l, !vdot_vopp_r. rewrite (vdot_comm b a).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     rewrite !a2r_add, !a2r_opp at 1. ring.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (* 柯西.许西尔兹不等式，Cauchy-Schwarz Inequality *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** |<a, b>| <= ||a|| * ||b|| *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vdot_abs_le : forall {n} (v1 v2 : vec n), (|a2r (<a, b>)| <= ||a|| * ||b||)%R.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. pose proof (vdot_sqr_le v1 v2).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     apply a2r_le_iff in H. rewrite !a2r_mul in H.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     rewrite (vdot_same a) in H. rewrite (vdot_same b) in H.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     replace (||a||² * ||b||²)%R with ((||a|| * ||b||)²) in H; [| cbv;ring].
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     apply Rsqr_le_abs_0 in H.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     replace (|(||a|| * ||b||)|)%R with (||a|| * ||b||)%R in H; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     rewrite !Rabs_right; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     pose proof (vlen_ge0 a). pose proof (vlen_ge0 b). ra.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** <a, b> <= ||a|| * ||b|| *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vdot_le_mul_vlen : forall {n} (v1 v2 : vec n), (a2r (<a, b>) <= ||a|| * ||b||)%R.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof. intros. pose proof (vdot_abs_le v1 v2). apply Rabs_le_rev in H. ra. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** - ||a|| * ||b|| <= <a, b> *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vdot_ge_mul_vlen_neg : forall {n} (v1 v2 : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       (- (||a|| * ||b||) <= a2r (<a, b>))%R.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof. intros. pose proof (vdot_abs_le v1 v2). apply Rabs_le_rev in H. ra. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (* 任意维度“三角形”的任意一边的长度小于等于两边长度之和 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** ||a + b|| <= ||a|| + ||a|| *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vlen_le_add : forall {n} (v1 v2 : vec n), (||(a + b)%V|| <= ||a|| + ||b||)%R.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. apply Rsqr_incr_0_var.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     2:{ unfold vlen; ra. }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     rewrite Rsqr_plus. rewrite <- !vdot_same.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     replace (a2r (<a + b, a + b>))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       with (a2r (<a, a>) + a2r (<b, b>) + (2 * a2r (<a, b>)))%R.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     2:{ rewrite vdot_vadd_l,!vdot_vadd_r.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         rewrite (vdot_comm b a). rewrite !a2r_add at 1. ra. }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     apply Rplus_le_compat_l.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     rewrite !associative. apply Rmult_le_compat_l; ra.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     pose proof (vdot_abs_le v1 v2). unfold Rabs in H.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     destruct Rcase_abs; ra.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (* 任意维度“三角形”的任意一边的长度大于等于两边长度之差 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** ||a|| - ||b|| <= ||a + b|| *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vlen_ge_sub : forall {n} (v1 v2 : vec n), ((||a|| - ||b||) <= ||(a + b)%V||)%R.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. apply Rsqr_incr_0_var.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     2:{ unfold vlen; ra. }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     rewrite Rsqr_minus. rewrite <- !vdot_same.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     replace (a2r (<a + b, a + b>))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       with (a2r (<a, a>) + a2r (<b, b>) + (2 * a2r (<a, b>)))%R.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     2:{ rewrite vdot_vadd_l,!vdot_vadd_r.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         rewrite (vdot_comm b a). rewrite !a2r_add at 1. ra. }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     apply Rplus_le_compat_l.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     pose proof (vdot_abs_le v1 v2). unfold Rabs in H.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     destruct Rcase_abs; ra.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 End OrderedARing.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Section OrderedField_Dec.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Context `{HOrderedField
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       : OrderedField A Aadd Azero Aopp Amul Aone Ainv Alt Ale}.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Context {AeqDec : Dec (@eq A)}.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Infix "<=" := Ale : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** ||a|| = 0 <-> v = 0 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vlen_eq0_iff_eq0 : forall {n} (v : vec n), ||a|| = 0%R <-> a = vzero.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. unfold vlen. split; intros.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - apply vdot_same_eq0_then_vzero. apply sqrt_eq_0 in H; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       apply a2r_eq0_iff; auto. apply a2r_ge0_iff; apply vdot_ge0.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - rewrite H. rewrite vdot_0_l. rewrite a2r_0 at 1. ra.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** ||a|| <> 0 <-> a <> 0 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vlen_neq0_iff_neq0 : forall {n} (v : vec n), ||a|| <> 0%R <-> a <> vzero.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof. intros. rewrite vlen_eq0_iff_eq0. easy. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** a <> vzero -> 0 < ||a|| *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vlen_gt0 : forall {n} (v : vec n), a <> vzero -> (0 < ||a||)%R.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof. intros. pose proof (vlen_ge0 a). apply vlen_neq0_iff_neq0 in H; ra. Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** 0 <= <a, a> *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vdot_same_ge0 : forall {n} (v : vec n), (Azero <= <a, a>)%A.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. destruct (Aeqdec a vzero) as [H|H].
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - subst. rewrite vdot_0_l. apply le_refl.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - apply le_if_lt. apply vdot_gt0; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 End OrderedField_Dec.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               End vlen.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               #[export] Hint Resolve vlen_ge0 : vec.


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (* ======================================================================= *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (** ** Unit vector *)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Section vunit.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Context `{HARing : ARing}.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Add Ring ring_inst : (make_ring_theory HARing).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation "1" := Aone.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vzero := (vzero Azero).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vopp := (@vopp _ Aopp).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vdot := (@vdot _ Aadd Azero Amul).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation "< a , b >" := (vdot v1 v2) : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** A unit vector `a` is a vector whose length equals one.
      Here, we use the square of length instead of length directly,
      but this is reasonable with the proof of vunit_spec. *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Definition vunit {n} (v : vec n) : Prop := <a, a> = 1.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** vunit a <-> vunit (vopp a). *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Lemma vopp_vunit : forall {n} (v : vec n), vunit (vopp a) <-> vunit a.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   intros. unfold vunit. rewrite vdot_vopp_l, vdot_vopp_r.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   rewrite group_opp_opp. easy.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Section Field.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Context `{HField : Field A Aadd Azero Aopp Amul Aone Ainv}.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** The unit vector cannot be zero vector *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vunit_neq0 : forall {n} (v : vec n), vunit a -> a <> vzero.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. intro. rewrite H0 in H. unfold vunit in H.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     rewrite vdot_0_l in H. apply field_1_neq_0. easy.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 End Field.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Section ConvertToR.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Context `{HConvertToR : ConvertToR A Aadd Azero Aopp Amul Aone Ainv Alt Ale}.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Notation vlen := (@vlen _ Aadd Azero Amul a2r).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Notation "|| a ||" := (vlen a) : vec_scope.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** Verify the definition is reasonable *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vunit_spec : forall {n} (v : vec n), vunit a <-> ||a|| = 1%R.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof. intros. split; intros; apply vlen_eq1_iff_vdot1; auto. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 End ConvertToR.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (** If column of a and column of b all are unit, 
    then column of (a * b) is also unit *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (*   a : mat 2 2 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (* a1 : vunit (mat2col a 0) *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (* a2 : vunit (mat2col a 1) *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (* a3 : vorth (mat2col a 0) (mat2col a 1) *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (* b1 : vunit (mat2col b 0) *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (* b2 : vunit (mat2col b 1) *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (* b3 : vorth (mat2col b 0) (mat2col b 1) *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (* ============================ *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (* vunit (mat2col (a * b) 0) *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               End vunit.


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (* ======================================================================= *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (** ** Orthogonal vectors 正交的两个向量 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Section vorth.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (* Two vectors, u and v, in an inner product space v, are orthogonal (also called 
     perpendicular) if their inner-product is zero. It can be denoted as `u ⟂ v` *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (* Let's have an Abelian-ring *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Context `{HARing : ARing A Aadd Azero Aopp Amul Aone}.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Add Ring ring_inst : (make_ring_theory HARing).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "+" := Aadd : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "*" := Amul : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation "- a" := (Aopp a) : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation Asub v1 v2 := (a + (- b))%A.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "-" := Asub : A_scope.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vzero := (vzero Azero).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vadd := (@vadd _ Aadd).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vopp := (@vopp _ Aopp).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vsub := (@vsub _ Aadd Aopp).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vcmul := (@vcmul _ Amul).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vdot := (@vdot _ Aadd Azero Amul).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "+" := vadd : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation "- a" := (vopp a) : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "-" := vsub : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "\.*" := vcmul : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation "< a , b >" := (vdot v1 v2) : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Definition vorth {n} (v1 v2 : vec n) : Prop := <a, b> = Azero.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "_|_" := vorth : vec_scope.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** a _|_ b -> b _|_ a *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Lemma vorth_comm : forall {n} (v1 v2 : vec n), a _|_ b -> b _|_ a.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof. intros. unfold vorth in *. rewrite vdot_comm; auto. Qed.


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (* If equip a `Dec` and a `Field` *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Section Dec_Field.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Context {AeqDec : Dec (@eq A)}.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Context `{HField : Field A Aadd Azero Aopp Amul Aone Ainv}.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** (x .* a) _|_ b <-> a _|_ b *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vorth_vcmul_l : forall {n} x (v1 v2 : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       x <> Azero -> ((x \.* a) _|_ b <-> a _|_ b).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. unfold vorth in *. rewrite vdot_vcmul_l. split; intros.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - apply field_mul_eq0_iff in H0. destruct H0; auto. easy.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - rewrite H0. ring.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** a _|_ (x .* b) <-> a _|_ b *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vorth_vcmul_r : forall {n} x (v1 v2 : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       x <> Azero -> (a _|_ (x \.* b) <-> a _|_ b).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. split; intros.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - apply vorth_comm in H0. apply vorth_comm. apply vorth_vcmul_l in H0; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - apply vorth_comm in H0. apply vorth_comm. apply vorth_vcmul_l; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 End Dec_Field.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               End vorth.



                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (** ** Projection component of a vector onto another *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Section vproj.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (* Let's have an field *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Context `{F:Field A Aadd Azero Aopp Amul Aone Ainv}.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Add Field field_inst : (make_field_theory F).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "+" := Aadd : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "*" := Amul : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation "- a" := (Aopp a) : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation Asub v1 v2 := (a + (- b))%A.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "-" := Asub : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation "/ a" := (Ainv a) : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation Adiv v1 v2 := (a * (/ b))%A.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "/" := Adiv : A_scope.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vzero := (vzero Azero).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vadd := (@vadd _ Aadd).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vopp := (@vopp _ Aopp).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vsub := (@vsub _ Aadd Aopp).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vcmul := (@vcmul _ Amul).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vdot := (@vdot _ Aadd Azero Amul).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vunit := (@vunit _ Aadd Azero Amul Aone).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vorth := (@vorth _ Aadd Azero Amul).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "+" := vadd : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation "- a" := (vopp a) : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "-" := vsub : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "\.*" := vcmul : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation "< a , b >" := (vdot v1 v2) : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "_|_" := vorth : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** The projection component of `a` onto `b` *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Definition vproj {n} (v1 v2 : vec n) : vec n := (<a, b> / <b, b>) \.* b.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** a _|_ b -> vproj v1 v2 = vzero *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Lemma vorth_imply_vproj_eq0 : forall {n} (v1 v2 : vec n), a _|_ b -> vproj v1 v2 = vzero.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   intros. unfold vorth in H. unfold vproj. rewrite H.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   replace (Azero * / (<b, b>)) with Azero. apply vcmul_0_l.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   rewrite ring_mul_0_l; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** vunit b -> vproj v1 v2 = <a, b> .* b *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Lemma vproj_vunit : forall {n} (v1 v2 : vec n), vunit b -> vproj v1 v2 = <a, b> \.* b.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof. intros. unfold vproj. f_equal. rewrite H. field. apply field_1_neq_0. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (* If equip a `Field` *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Section OrderedField.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Context `{HOrderedField : OrderedField A Aadd Azero Aopp Amul Aone Ainv}.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** vproj (a + b) c = vproj a c + vproj b c *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vproj_vadd : forall {n} (v1 v2 c : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       c <> vzero -> (vproj (a + b) c = vproj a c + vproj b c)%V.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. unfold vproj. rewrite vdot_vadd_l. rewrite <- vcmul_add. f_equal.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     field. apply vdot_same_neq0_if_vnonzero; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** vproj (x .* a) b = x .* (vproj v1 v2) *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vproj_vcmul : forall {n} (v1 v2 : vec n) x,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       b <> vzero -> (vproj (x \.* a) b = x \.* (vproj v1 v2))%V.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. unfold vproj. rewrite vdot_vcmul_l. rewrite vcmul_assoc. f_equal.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     field. apply vdot_same_neq0_if_vnonzero; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** vproj a a = a *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vproj_same : forall {n} (v : vec n), a <> vzero -> vproj a a = a.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. unfold vproj. replace (<a, a> / <a, a>) with Aone; try field.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     apply vcmul_1_l. apply vdot_same_neq0_if_vnonzero; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 End OrderedField.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               End vproj.


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (* ======================================================================= *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (** ** Perpendicular component of a vector respect to another *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Section vperp.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (* Let's have an field *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Context `{F:Field A Aadd Azero Aopp Amul Aone Ainv}.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Add Field field_inst : (make_field_theory F).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "+" := Aadd : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "*" := Amul : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation "- a" := (Aopp a) : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation Asub v1 v2 := (a + (- b))%A.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "-" := Asub : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation "/ a" := (Ainv a) : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation Adiv v1 v2 := (a * (/ b))%A.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "/" := Adiv : A_scope.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vzero := (vzero Azero).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vadd := (@vadd _ Aadd).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vopp := (@vopp _ Aopp).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vsub := (@vsub _ Aadd Aopp).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vcmul := (@vcmul _ Amul).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vdot := (@vdot _ Aadd Azero Amul).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vproj := (@vproj _ Aadd Azero Amul Ainv).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vorth := (@vorth _ Aadd Azero Amul).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "+" := vadd : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation "- a" := (vopp a) : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "-" := vsub : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "\.*" := vcmul : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation "< a , b >" := (vdot v1 v2) : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "_|_" := vorth : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** The perpendicular component of `a` respect to `b` *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Definition vperp {n} (v1 v2 : vec n) : vec n := a - vproj v1 v2.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** vperp v1 v2 = a - vproj v1 v2 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Lemma vperp_eq_minus_vproj : forall {n} (v1 v2 : vec n), vperp v1 v2 = a - vproj v1 v2.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof. auto. Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** vproj v1 v2 = a - vperp v1 v2 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Lemma vproj_eq_minus_vperp : forall {n} (v1 v2 : vec n), vproj v1 v2 = a - vperp v1 v2.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   intros. unfold vperp. unfold vsub. rewrite group_opp_distr.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   rewrite group_opp_opp. move2h (vproj v1 v2). group.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** (vproj v1 v2) + (vperp v1 v2) = a *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Lemma vproj_plus_vperp : forall {n} (v1 v2 : vec n), vproj v1 v2 + vperp v1 v2 = a.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof. intros. unfold vperp. unfold vsub. move2h a. group. Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** a _|_ b -> vperp v1 v2 = a *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Lemma vorth_imply_vperp_eq_l : forall {n} (v1 v2 : vec n), a _|_ b -> vperp v1 v2 = a.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   intros. unfold vperp. rewrite vorth_imply_vproj_eq0; auto. apply vsub_0_r.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (* If equip a `OrderedField` *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Section OrderedField.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Context `{HOrderedField : OrderedField A Aadd Azero Aopp Amul Aone Ainv}.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** (vproj v1 v2) _|_ (vperp v1 v2) *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vorth_vproj_vperp : forall {n} (v1 v2 : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       b <> vzero -> vproj v1 v2 _|_ vperp v1 v2.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. unfold vorth, vperp, vproj.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     rewrite !vdot_vcmul_l. rewrite vdot_vsub_r. rewrite !vdot_vcmul_r.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     rewrite (vdot_comm b a). field_simplify. rewrite ring_mul_0_l; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     apply vdot_same_neq0_if_vnonzero; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** vperp (a + b) c = vperp a c + vperp b c *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vperp_vadd : forall {n} (v1 v2 c : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       c <> vzero -> (vperp (a + b) c = vperp a c + vperp b c)%V.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. unfold vperp. rewrite vproj_vadd; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     unfold vsub. asemigroup. rewrite vopp_vadd. auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** vperp (x .* a) b = x .* (vperp v1 v2) *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vperp_vcmul : forall {n} (x : A) (v1 v2 : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       b <> vzero -> (vperp (x \.* a) b = x \.* (vperp v1 v2))%V.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. unfold vperp. rewrite vproj_vcmul; auto. rewrite vcmul_vsub. easy.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** vperp a a = vzero *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vperp_self : forall {n} (v : vec n), a <> vzero -> vperp a a = vzero.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. unfold vperp. rewrite vproj_same; auto; auto. apply vsub_self.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 End OrderedField.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               End vperp.


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (* ======================================================================= *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (** ** Two vectors are parallel (on vnonzero version) *)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (* 关于零向量的平行和垂直问题
  1. 来自《高等数学》的理论：
  (1) 零向量的起点和终点重合，它的方向可看做是任意的。
  (2) 如果∠a,b = 0 or π，则称它们平行，记做 a//b。
      当两向量平行时，若将起点放在同一点，则终点和公共起点应在同一条直线，故
      两向量平行也称两向量共线。
  (3) 如果∠a,b = π/2，称它们垂直，记做 a⟂b。
  (4) 由于零向量与另一向量的夹角可以是[0,π]中的任意值，可认为零向量与任何向量
      都平行，也可认为零向量与任何向量都垂直。
  2. 网络上的观点
  (1) There are two choices to handling zero-vector
      a. The mainstream approach is that the zero vector is parallel and
         perpendicular to any vector.
      b. Only consider the non-zero vector, one reason of it is that the 
         transitivity is broken after including zero-vector.
         (因为包含了零向量以后，平行的传递性被破坏了）
  (2) https://www.zhihu.com/question/489006373
      a. “平行”或“不平行”是对两个可以被识别的方向的比较，对于零向量，“方向”是不可
         识别的，或说，是不确定的。从这个角度讲，“平行”这个概念不该被用到评价两个
         零向量的关系上的。
      b. 不过，两个零向量是“相等”的，对于向量而言，“相等”这件事包含了大小和方向
         的相等，这么说来，说两个零向量“方向”相等，也就是“平行”或也是说得通的。
  3. 使用向量运算的做法
  (1) 使用向量的运算来定义平行和垂直，这样无须三角函数就能判定。
      两向量点乘为零，则它们垂直；两向量叉乘为零向量，则它们平行。
  (2) 在严格证明中，都加上非零向量这一假设条件。
  4. 本文的做法
  (1) vnonzero 类型：表示非零向量。
      在这个类型上定义平行、垂直、角度等。
      换言之，零向量上未定义几何关系。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                *)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (* 一种方式是使用子类型 `vnonzero` 来实现 `vpara` 的版本。
   这种做法的特点是：
   1. `vpara`成了等价关系（因为排除了非零向量，而且将非零的条件封装到了类型中）
   2. 同时也带来了一些构造上的繁琐性。因为返回该类型的函数必须要证明其满足非零的条件。
   3. 同时也使得其他相关的函数都要使用 vnonzero 版本，可能过于复杂。
   所以，当一个概念特别有应用需求时，才考虑用这种子类型的方式。
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Module demo_vpara_on_vnonzero.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Context `{HARing : ARing}.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vcmul := (@vcmul _ Amul).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "\.*" := vcmul : vec_scope.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** Non-zero element *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Record Anonzero :=
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   mknonzero {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       nonzero :> A;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       cond_nonzero : nonzero <> Azero
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     }.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** Non-zero vector *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Record vnonzero n :=
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   mkvnonzero {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       vnonzeroV :> @vec A n ;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       vnonzero_cond : vnonzeroV <> vzero Azero
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     }.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** Two non-zero vectors are parallel, when their components are proportional *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Definition vpara {n} (v1 v2 : vnonzero n) : Prop :=
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   exists x : A, x \.* v1 == v2.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               End demo_vpara_on_vnonzero.


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (* ======================================================================= *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (** ** Two vectors are collinear, parallel or antiparallel. *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (* https://en.wikipedia.org/wiki/Euclidean_vector
   Two vectors are parallel if they have the same direction but not
   necessarily the same magnitude, or antiparallel if they have opposite
   direction but not necessarily the same magnitude *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Section vcoll_vpara_vantipara.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (* 
     1. we need order relation to distinguish "x > 0 or x < 0" to define parallel
        and antiparallel
     2. we need to prove the reflexivity of collinear, so need a nonzero coefficient
        x, such as 1, thus need a field.
     3. we need a coefficent x and 1/x to prove the symmetric of collinear, so we 
        need a field.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Context `{HOrderedField
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     : OrderedField A Aadd Azero Aopp Amul Aone Ainv Alt Ale Altb Aleb}.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Add Field field_inst : (make_field_theory HOrderedField).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation "0" := Azero : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation "1" := Aone : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "<" := Alt : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "<=" := Ale : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "+" := Aadd : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "*" := Amul : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation "- a" := (Aopp a) : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation Asub v1 v2 := (a + (- b))%A.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "-" := Asub : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation "/ a" := (Ainv a) : A_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation Adiv v1 v2 := (a * (/ b))%A.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "/" := Adiv : A_scope.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vzero := (vzero Azero).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vadd := (@vadd _ Aadd).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vopp := (@vopp _ Aopp).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vsub := (@vsub _ Aadd Aopp).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation vcmul := (@vcmul _ Amul).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "+" := vadd : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Notation "- a" := (vopp a) : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "-" := vsub : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "\.*" := vcmul : vec_scope.


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** *** Colinear *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Section vcoll.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** Two non-zero vectors are collinear, if the components are proportional *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (* Note, x <> 0 could be removed, but it need a prove *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Definition vcoll {n} (v1 v2 : vec n) : Prop :=
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     a <> vzero /\ b <> vzero /\ exists x : A, x <> 0 /\ x \.* v1 == v2.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Infix "//" := vcoll : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** a // a *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vcoll_refl : forall {n} (v : vec n), a <> vzero -> a // a.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. hnf. repeat split; auto. exists 1. split.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     apply field_1_neq_0. apply vcmul_1_l.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** a // b -> b // a *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vcoll_sym : forall {n} (v1 v2 : vec n), a // b -> b // a.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. hnf in *. destruct H as [H11 [H12 [x [H13 H14]]]].
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     repeat split; auto. exists (/x). split; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     apply field_inv_neq0_iff; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     rewrite <- H14. rewrite vcmul_assoc. rewrite field_mulInvL; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     apply vcmul_1_l.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** a // b -> b // c -> a // c *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vcoll_trans : forall {n} (v1 v2 c : vec n), a // b -> b // c -> a // c.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. hnf in *.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     destruct H as [H11 [H12 [x1 [H13 H14]]]].
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     destruct H0 as [H21 [H22 [x2 [H23 H24]]]].
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     repeat split; auto. exists (x2 * x1).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     split. apply field_mul_neq0_iff; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     rewrite <- H24, <- H14. rewrite vcmul_assoc. auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** a // b => ∃! x, x <> 0 /\ x .* v1 == v2 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vcoll_imply_uniqueX : forall {n} (v1 v2 : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       a // b -> (exists ! x, x <> 0 /\ x \.* v1 == v2).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. destruct H as [H1 [H2 [x [H3 H4]]]]. exists x. split; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros j [H5 H6]. rewrite <- H4 in H6.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     apply vcmul_sameV_imply_eqX in H6; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** a // b -> (x .* a) // b *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vcoll_vcmul_l : forall {n} x (v1 v2 : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       x <> 0 -> a // b -> x \.* a // b.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. hnf in *. destruct H0 as [H1 [H2 [x1 [H3 H4]]]].
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     repeat split; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - intro. apply vcmul_eq0_imply_x0_or_v0 in H0. destruct H0; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - exists (x1/x); simpl. split.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       apply field_mul_neq0_iff. split; auto. apply field_inv_neq0_iff; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       rewrite <- H4. rewrite vcmul_assoc. f_equal. field. auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** a // b -> a // (x \.* b) *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vcoll_vcmul_r : forall {n} x (v1 v2 : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       x <> 0 -> a // b -> a // (x \.* b).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. apply vcoll_sym in H0. apply vcoll_sym. apply vcoll_vcmul_l; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 End vcoll.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** *** Properties about //+ *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Section vpara.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** Two non-zero vectors are parallel, if positive proportional *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Definition vpara {n} (v1 v2 : vec n) : Prop :=
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     a <> vzero /\ b <> vzero /\ exists x : A, 0 < x /\ x \.* v1 == v2.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Infix "//+" := vpara : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** a //+ a *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vpara_refl : forall {n} (v : vec n), a <> vzero -> a //+ a.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. hnf. repeat split; auto. exists 1. split. apply lt_0_1. apply vcmul_1_l.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** a //+ b -> b //+ a *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vpara_sym : forall {n} (v1 v2 : vec n), a //+ b -> b //+ a.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. hnf in *. destruct H as [H11 [H12 [x [H13 H14]]]].
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     repeat split; auto. exists (/x). split; auto. apply inv_gt0; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     rewrite <- H14. rewrite vcmul_assoc. rewrite field_mulInvL; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     apply vcmul_1_l. symmetry. apply lt_not_eq; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** a //+ b -> b //+ c -> a //+ c *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vpara_trans : forall {n} (v1 v2 c: vec n), a //+ b -> b //+ c -> a //+ c.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. hnf in *.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     destruct H as [H11 [H12 [x1 [H13 H14]]]].
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     destruct H0 as [H21 [H22 [x2 [H23 H24]]]].
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     repeat split; auto. exists (x2 * x1). split. apply mul_gt0_if_gt0_gt0; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     rewrite <- H24, <- H14. rewrite vcmul_assoc. auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** a //+ b => ∃! x, 0 < x /\ x .* v1 == v2 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vpara_imply_uniqueX : forall {n} (v1 v2 : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       a //+ b -> (exists ! x, 0 < x /\ x \.* v1 == v2).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. destruct H as [H1 [H2 [x [H3 H4]]]]. exists x. split; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros j [H5 H6]. rewrite <- H4 in H6.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     apply vcmul_sameV_imply_eqX in H6; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** a //+ b -> (x \.* a) //+ b *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vpara_vcmul_l : forall {n} x (v1 v2 : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       0 < x -> a //+ b -> x \.* a //+ b.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. hnf in *. destruct H0 as [H1 [H2 [x1 [H3 H4]]]].
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     repeat split; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - intro. apply vcmul_eq0_imply_x0_or_v0 in H0. destruct H0; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       apply lt_not_eq in H. rewrite H0 in H. easy.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - exists (x1/x); simpl. split.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       + apply mul_gt0_if_gt0_gt0; auto. apply inv_gt0; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       + rewrite <- H4. rewrite vcmul_assoc. f_equal. field.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         symmetry. apply lt_not_eq. auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** a //+ b -> a //+ (x \.* b) *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vpara_vcmul_r : forall {n} x (v1 v2 : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       0 < x -> a //+ b -> a //+ (x \.* b).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. apply vpara_sym in H0. apply vpara_sym. apply vpara_vcmul_l; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 End vpara.


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** *** Properties about //- *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Section vantipara.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** Two non-zero vectors are antiparallel, if negative proportional *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Definition vantipara {n} (v1 v2 : vec n) : Prop :=
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     a <> vzero /\ b <> vzero /\ exists x : A, x < 0 /\ x \.* v1 == v2.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Infix "//-" := vantipara : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** a //- a *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vantipara_refl : forall {n} (v : vec n), a <> vzero -> a //- a.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. hnf. repeat split; auto. exists (-(1))%A. split.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     apply gt0_iff_neg. apply lt_0_1.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     (* Note that, this is not true *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Abort.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** a //- b -> b //- a *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vantipara_sym : forall {n} (v1 v2 : vec n), a //- b -> b //- a.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. hnf in *. destruct H as [H11 [H12 [x [H13 H14]]]].
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     repeat split; auto. exists (/x). split; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     apply inv_lt0; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     rewrite <- H14. rewrite vcmul_assoc. rewrite field_mulInvL; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     apply vcmul_1_l. apply lt_not_eq; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** a //- b -> b //- c -> a //- c *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vantipara_trans : forall {n} (v1 v2 c: vec n), a //- b -> b //- c -> a //- c.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. hnf in *.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     destruct H as [H11 [H12 [x1 [H13 H14]]]].
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     destruct H0 as [H21 [H22 [x2 [H23 H24]]]].
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     repeat split; auto. exists (x2 * x1). split.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     2:{ rewrite <- H24, <- H14. rewrite vcmul_assoc. auto. }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     (* Note that, this is not true *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Abort.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** a //- b => ∃! x, x < 0 /\ x .* v1 == v2 *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vantipara_imply_uniqueX : forall {n} (v1 v2 : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       a //- b -> (exists ! x, x < 0 /\ x \.* v1 == v2).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. destruct H as [H1 [H2 [x [H3 H4]]]]. exists x. split; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros j [H5 H6]. rewrite <- H4 in H6.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     apply vcmul_sameV_imply_eqX in H6; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** a //- b -> (x .* a) //- b *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vantipara_vcmul_l : forall {n} x (v1 v2 : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       0 < x -> a //- b -> x \.* a //- b.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. hnf in *. destruct H0 as [H1 [H2 [x1 [H3 H4]]]].
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     repeat split; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - intro. apply vcmul_eq0_imply_x0_or_v0 in H0. destruct H0; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       apply lt_not_eq in H. rewrite H0 in H. easy.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - exists (x1/x); simpl. split.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       + apply mul_lt0_if_lt0_gt0; auto. apply inv_gt0; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       + rewrite <- H4. rewrite vcmul_assoc. f_equal. field.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         symmetry. apply lt_not_eq. auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** a //- b -> a //- (x .* b) *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vantipara_vcmul_r : forall {n} x (v1 v2 : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       0 < x -> a //- b -> a //- (x \.* b).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. apply vantipara_sym in H0. apply vantipara_sym.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     apply vantipara_vcmul_l; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 End vantipara.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "//" := vcoll : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "//+" := vpara : vec_scope.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Infix "//-" := vantipara : vec_scope.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (** *** Convert between //, //+, and //-  *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Section convert.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** a //+ b -> a // b *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vpara_imply_vcoll : forall {n} (v1 v2 : vec n), a //+ b -> a // b.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. hnf in *. destruct H as [H11 [H12 [x [H13 H14]]]].
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     repeat split; auto. exists x. split; auto. symmetry. apply lt_imply_neq; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** a //- b -> a // b *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vantipara_imply_vcoll : forall {n} (v1 v2 : vec n), a //- b -> a // b.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. hnf in *. destruct H as [H11 [H12 [x [H13 H14]]]].
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     repeat split; auto. exists x. split; auto. apply lt_imply_neq; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** a //+ b -> (-a) //- b *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vpara_imply_vantipara_opp_l : forall {n} (v1 v2 : vec n), a //+ b -> (-a) //- b.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. hnf in *. destruct H as [H11 [H12 [x [H13 H14]]]].
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     repeat split; auto. apply group_opp_neq0_iff; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     exists (- x)%A. split. apply gt0_iff_neg; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     rewrite vcmul_opp, vcmul_vopp, <- H14. rewrite vopp_vopp. auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** a //+ b -> a //- (-b)*)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vpara_imply_vantipara_opp_r : forall {n} (v1 v2 : vec n), a //+ b -> a //- (-b).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. hnf in *. destruct H as [H11 [H12 [x [H13 H14]]]].
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     repeat split; auto. apply group_opp_neq0_iff; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     exists (- x)%A. split. apply gt0_iff_neg; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     rewrite vcmul_opp. rewrite H14. auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (** a // b -> (a //+ b) \/ (a //- b) *)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Lemma vpara_imply_vpara_or_vantipara : forall {n} (v1 v2 : vec n),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       a // b -> a //+ b \/ a //- b.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Proof.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     intros. hnf in *. destruct H as [H11 [H12 [x [H13 H14]]]].
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     destruct (lt_cases x 0) as [[Hlt|Hgt]|Heq0].
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - right. hnf. repeat split; auto. exists x; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - left. hnf. repeat split; auto. exists x; auto.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - easy.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Qed.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 End convert.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               End vcoll_vpara_vantipara.
